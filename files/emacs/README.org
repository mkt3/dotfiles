-*- buffer-read-only: t -*-
#+title: Configurations for Emacs
#+author: Makoto Morinaga
#+startup: content
#+startup: nohideblocks

* Header
 #+begin_src emacs-lisp
   ;;; README.el --- init file for Emacs -*- coding: utf-8 ; lexical-binding: t -*-

   ;; Copyright (C) 2023 Makoto Morinaga

   ;; Author: Makoto Morinaga <makoto@mkt3.dev>

   ;;; Code:
 #+end_src
* Custom
  #+begin_src emacs-lisp
    (setq custom-file (locate-user-emacs-file "custom.el"))
  #+end_src
* Packages
** Package manager
   #+begin_src emacs-lisp
     (eval-and-compile
       (customize-set-variable
        'package-archives '(("org" . "https://orgmode.org/elpa/")
                            ("melpa" . "https://melpa.org/packages/")
                            ("gnu" . "https://elpa.gnu.org/packages/")
                            ("nongnu" . "https://elpa.nongnu.org/nongnu/")))
       (package-initialize)
       (setq use-package-hook-name-suffix nil)
       (use-package delight :ensure t))
   #+end_src
** Auto package update
   #+begin_src emacs-lisp
     (use-package auto-package-update
       :ensure t
       :config
       (setq auto-package-update-delete-old-versions t)
       (setq auto-package-update-hide-results t)
       (setq auto-package-update-excluded-packages '(pdf-tools jinx mu4e))
       (auto-package-update-maybe))
   #+end_src
* Initialize
** Load Path
   #+begin_src emacs-lisp
     (use-package exec-path-from-shell
       :ensure t
       :if (display-graphic-p)
       :config
       (setq exec-path-from-shell-arguments  "") ;; Since the UI is set to interactive in .zshrc.
       (setq exec-path-from-shell-variables  '("PATH" "GOPATH" "NAME" "ORG_HUGO" "RUSTUP_HOME" "CARGO_HOME" "SSH_AUTH_SOCK" "SSH_AGENT_PID" "GNUPGHOME" "PASSWORD_STORE_DIR" "GPG_KEY_ID" "RECOLL_CONFDIR"))
       (exec-path-from-shell-initialize))
   #+end_src
** Constant
   #+begin_src emacs-lisp
     (defconst my:d:nextcloud (expand-file-name "Nextcloud" (getenv "HOME")))
     (defconst my:d:org (expand-file-name "orgnotes" my:d:nextcloud))
     (defconst my:d:org-gtd (expand-file-name "gtd" my:d:org))
     (defconst my:d:org-roam (expand-file-name "roam" my:d:org))
     (defconst my:f:bib (expand-file-name "zotero/zotero.bib" my:d:nextcloud))
     (defconst my:d:org-hugo (getenv "ORG_HUGO"))
     (defconst my:d:password-store (or (getenv "PASSWORD_STORE_DIR") ""))
   #+end_src
* Builtin config
** scroll
   #+begin_src emacs-lisp
     (setq scroll-preserve-screen-position t
           scroll-margin 5
           scroll-conservatively 1
           next-screen-context-lines 5
           pixel-scroll-precision-mode 1)
   #+end_src
** symlink
   Automatically visit symlink sources
   #+begin_src emacs-lisp
     (use-package vc-hooks :custom (vc-follow-symlinks t))
     (setq-default find-file-visit-truename t)
     #+end_src
** tab
   #+begin_src emacs-lisp
     (setq-default
      indent-tabs-mode nil
      tab-width 4
      tab-always-indent t)
   #+end_src
** Truncate line
   #+begin_src emacs-lisp
     (setq truncate-lines nil
           truncate-partial-width-windows nil)

     (use-package adaptive-wrap
       :ensure t
       :hook ((markdown-mode-hook org-mode-hook nov-mode-hook) . adaptive-wrap-prefix-mode))
   #+end_src
** Delete
   #+begin_src emacs-lisp
     (bind-key "C-h" 'delete-backward-char)
     (bind-key "C-x ?" 'help-command)
     (use-package delsel
       :custom
       (delete-selection-mode t))
   #+end_src
** Assigning directory name to the same buffer name
   #+begin_src emacs-lisp
     (use-package uniquify
       :custom
       (uniquify-buffer-name-style  'post-forward-angle-brackets)
       (uniquify-min-dir-content  1)
       (funiquify-ignore-buffers-re  "*[^*]+*"))
   #+end_src
** Save various history
   #+begin_src emacs-lisp
     (use-package savehist
       :custom
       (savehist-autosave-interval 60)
       (history-delete-duplicates t)
       (history-length 1000)
       (savehist-additional-variables '(kill-ring
                                        search-ring
                                        regexp-search-ring
                                        file-name-history
                                        read-expression-history
                                        command-history
                                        extended-command-history))
       :config
       (savehist-mode))
   #+end_src
** Line number
   #+begin_src emacs-lisp
     (use-package display-line-numbers
       :config
       (global-display-line-numbers-mode))
   #+end_src
** Disable auto generate file
   #+begin_src emacs-lisp
     (use-package files
       :custom ((make-backup-files nil)
                (auto-save-default nil)))
   #+end_src
** Time
   #+begin_src emacs-lisp
     (use-package time
       :custom
       (display-time-string-forms  '(month "/" day "(" dayname ") " 24-hours ":" minutes))
       (display-time-mode t))
   #+end_src
** Auto revert
   #+begin_src emacs-lisp
     (use-package autorevert
       :delight auto-revert-mode
       :custom
       (auto-revert-interval 0.1)
       :config
       (global-auto-revert-mode))
   #+end_src
** Parentheses
   #+begin_src emacs-lisp
     (use-package paren
       ;; :custom-face (show-paren-match . '((t
       ;;                                     (:weight regular
       ;;                                              :background "#44475a"
       ;;                                              :underline "$ffff00"))))
       :custom
       (show-paren-delay 0.0)
       (show-paren-mode t))
   #+end_src
** Window
   #+begin_src emacs-lisp
     (use-package windmove
       :custom
       (windmove-wrap-around  t)
       :bind (("C-M-h" . windmove-left)
              ("C-M-k" . windmove-up)
              ("C-M-j" . windmove-down)
              ("C-M-l" . windmove-right)))
   #+end_src
** Save file browsing history
   #+begin_src emacs-lisp
     (use-package recentf
       :init
       (setq recentf-exclude '(".recentf"
                               "^/tmp\\.*"
                               "bookmarks"
                               "\\.gpg"
                               "Nextcloud/orgnotes"))
       :config
       (recentf-mode))
   #+end_src
** Save last cursor position
   #+begin_src emacs-lisp
     (use-package saveplace
       :custom
       (save-place-mode t))
   #+end_src
** Encrypting/decrypting
   #+begin_src emacs-lisp
     (use-package epg
       :custom
       (epg-pinentry-mode 'loopback)
       :config
       ;; https://www.reddit.com/r/emacs/comments/14t3jcb/anyone_seen_if_gnupg_243_encryption_with_emacs/
       ;; (fset 'epg-wait-for-status 'ignore)
       )

     (use-package epa
       :after epg
       :config
       (require 'epa-file)
       (epa-file-enable)
       )

     (use-package password-store :ensure t)

     (use-package plstore
       :if (file-directory-p my:d:password-store)
       :mode (("\\.plist\\'" . plstore-mode))
       :custom
       (plstore-encrypt-to (getenv "GPG_KEY_ID"))
       :config
       (setq store (plstore-open (expand-file-name "plstore.plist" my:d:password-store))))

     (use-package auth-source
       :if (file-directory-p my:d:password-store)
       :custom
       (auth-source-gpg-encrypt-to (getenv "GPG_KEY_ID"))
       :config
       (add-to-list 'auth-sources (expand-file-name "plstore.plist" my:d:password-store)))
   #+end_src
** Server
   #+begin_src emacs-lisp
     (when (and (not (server-running-p))
                (display-graphic-p))
       (server-start))
   #+end_src
** Misc
   #+begin_src emacs-lisp
     (setq
      use-short-answers t
      debug-on-error nil
      create-lockfiles nil
      enable-recursive-minibuffers t
      ring-bell-function 'ignore
      text-quoting-style 'straight
      user-full-name (getenv "NAME")
      completion-lazy-hilit t
      process-adaptive-read-buffering t
      require-final-newline t)

     (use-package simple
       :demand t
       :custom
       (kill-ring-max                100)
       (kill-read-only-ok            t)
       (eval-expression-print-length nil)
       (eval-expression-print-level  nil)
       (column-number-mode            t)
       :bind ("C-x j" . eval-print-last-sexp))
   #+end_src
* Appearance
** Color theme
*** ef-themes
    #+begin_src emacs-lisp
      (use-package ef-themes
        :ensure t
        :config
        (mapc #'disable-theme custom-enabled-themes)
        (load-theme 'ef-maris-dark :no-confirm)
        ;; (ef-themes-load-random 'dark)
        )
    #+end_src
*** Doom Nord
    #+begin_src emacs-lisp
      (use-package doom-themes
        :disabled
        :ensure t
        :config
        (load-theme 'doom-nord t))
    #+end_src
*** Modus theme
    #+begin_src emacs-lisp
      (use-package emacs
        :disabled
        :if (display-graphic-p)
        :config
        (require-theme 'modus-themes)
        (setq
         modus-themes-italic-constructs  t
         modus-themes-bold-constructs    t
         ;; modus-themes-org-blocks         'tinted-background
         modus-themes-org-blocks         'gray-background
         modus-themes-headings
         '((agenda-structure . (variable-pitch light 2.2))
           (agenda-date . (variable-pitch regular 1.3))
           (t . (regular 1.15))))
        (setq org-highlight-latex-and-related '(native))
        (load-theme 'modus-vivendi)
        ;; (load-theme 'modus-vivendi-tinted)
        )
    #+end_src
** Font
   #+begin_src emacs-lisp
     (when (display-graphic-p)
       (if (eq system-type 'darwin)
           (add-to-list 'default-frame-alist '(font . "PlemolJP Console NF-18"))
         (add-to-list 'default-frame-alist '(font . "PlemolJP Console NF-16"))))

     (use-package nerd-icons :ensure t)

     (use-package nerd-icons-dired
       :ensure t
       :hook (dired-mode-hook . nerd-icons-dired-mode))

     (use-package nerd-icons-completion
       :ensure t
       :after marginalia
       :config
       (nerd-icons-completion-mode)
       :hook (marginalia-mode-hook . #'nerd-icons-completion-marginalia-setup))

     (use-package nerd-icons-corfu
       :ensure t
       :after corfu
       :config
       (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))

     (use-package magit-file-icons
       :ensure t
       :after magit
       :init
       (magit-file-icons-mode 1)
       :custom
       ;; These are the default values:
       (magit-file-icons-enable-diff-file-section-icons t)
       (magit-file-icons-enable-untracked-icons t)
       (magit-file-icons-enable-diffstat-icons t))
   #+end_src
** Highlight-indent-guide
   #+begin_src emacs-lisp
     ;; (use-package highlight-indent-guides
     ;;   :ensure t
     ;;   :delight
     ;;   :hook ((prog-mode-hook yaml-mode-hook) . highlight-indent-guides-mode)
     ;;   :custom
     ;;   (highlight-indent-guides-method  'character)
     ;;   (highlight-indent-guides-auto-enabled t)
     ;;   (highlight-indent-guides-responsive t)
     ;;   (highlight-indent-guides-character ?\|))
   #+end_src
** rainbow-delimiters
   #+begin_src emacs-lisp
     (use-package rainbow-delimiters
       :ensure t
       :hook (prog-mode-hook . rainbow-delimiters-mode))
   #+end_src
** Nyan mode
   #+begin_src emacs-lisp
     (use-package nyan-mode
       :ensure t
       :init
       (nyan-mode 1))
   #+end_src
** tab-bar-mode
   #+begin_src emacs-lisp
     (use-package tab-bar
       :init (defvar my:tab-bar-map (make-sparse-keymap)
               "My original keymap binded for tab-bar.")
       (defalias 'my:tab-bar-prefix my:tab-bar-map)
       (keymap-set global-map "C-o" 'my:tab-bar-prefix)
       (keymap-set my:tab-bar-map "c"   'tab-new)
       (keymap-set my:tab-bar-map "C-c" 'tab-new)
       (keymap-set my:tab-bar-map "k"   'tab-close)
       (keymap-set my:tab-bar-map "C-k" 'tab-close)
       (keymap-set my:tab-bar-map "n"   'tab-next)
       (keymap-set my:tab-bar-map "C-n" 'tab-next)
       (keymap-set my:tab-bar-map "TAB" 'tab-next)
       (keymap-set my:tab-bar-map "p"   'tab-previous)
       (keymap-set my:tab-bar-map "C-p" 'tab-previous)
       (keymap-set my:tab-bar-map "1" '(lambda () (interactive) (tab-bar-select-tab 1)))
       (keymap-set my:tab-bar-map "2" '(lambda () (interactive) (tab-bar-select-tab 2)))
       (keymap-set my:tab-bar-map "3" '(lambda () (interactive) (tab-bar-select-tab 3)))
       (keymap-set my:tab-bar-map "4" '(lambda () (interactive) (tab-bar-select-tab 4)))
       (keymap-set my:tab-bar-map "5" '(lambda () (interactive) (tab-bar-select-tab 5)))
       (keymap-set my:tab-bar-map "6" '(lambda () (interactive) (tab-bar-select-tab 6)))
       (keymap-set my:tab-bar-map "7" '(lambda () (interactive) (tab-bar-select-tab 7)))
       (keymap-set my:tab-bar-map "8" '(lambda () (interactive) (tab-bar-select-tab 8)))
       (keymap-set my:tab-bar-map "9" '(lambda () (interactive) (tab-bar-select-tab 9)))
       (keymap-set my:tab-bar-map "0" '(lambda () (interactive) (tab-bar-select-tab 0)))
       :custom
       (tab-bar-close-button-show      nil)
       (tab-bar-close-last-tab-choice  nil)
       (tab-bar-close-tab-select       'left)
       (tab-bar-history-mode           nil)
       (tab-bar-new-tab-choice         "*scratch*")
       (tab-bar-new-button-show        nil)
       (tab-bar-tab-name-truncated-max 25)
       (tab-bar-separator              "")
       :config
       (defun my:name-tab-by-project-or-default ()
         "Return project name with hostname if in a project, or default tab-bar name if not.
     The default tab-bar name uses the buffer name."
         (let* ((project-current (project-current))
                (project-name (if project-current
                                  (project-name project-current)
                                nil)))
           (if project-name
               (let* ((dir (car (last project-current)))
                      (host-name (if (tramp-tramp-file-p dir)
                                     (tramp-file-name-host (tramp-dissect-file-name dir))
                                   "local"))
                      (full-name (if (string= host-name "")
                                     project-name
                                   (format "%s@%s" project-name host-name))))
                 full-name)
             (tab-bar-tab-name-current))))
       (setq tab-bar-tab-name-function #'my:name-tab-by-project-or-default)
       (setq tab-bar-select-tab-modifiers '(meta))
       (setq tab-bar-tab-hints t)
       (tab-bar-mode +1))
     (use-package project-tab-groups
       :ensure t
       :config
       (defun my:project-tab-groups-tab-group-name-advice (orig-fun &rest args)
         "Advise `project-tab-groups-tab-group-name' to include the hostname."
         (with-temp-buffer
           (let* ((dir (car args))
                  (default-directory dir)
                  (raw-name (apply orig-fun args))
                  (host-name (if (tramp-tramp-file-p dir)
                                 (tramp-file-name-host (tramp-dissect-file-name dir))
                               ""))
                  (name (if (string= host-name "")
                            raw-name
                          (format "%s@%s" raw-name host-name))))
             name)))
       (advice-add 'project-tab-groups-tab-group-name :around #'my:project-tab-groups-tab-group-name-advice)
       (project-tab-groups-mode 1))
   #+end_src
** dimmer
   Visually highlight the selected buffer.
   #+begin_src emacs-lisp
     (use-package dimmer
       :ensure t
       :custom
       (dimmer-fraction  0.5)
       (dimmer-exclusion-regexp-list  '(".*Minibuf.*" ".*which-key.*" ".*NeoTree.*"
                                        ".*Messages.*" ".*Async.*" ".*Warnings.*" ".*LV.*"
                                        ".*Ilist.*"))
       (dimmer-mode t))
   #+end_src
** Whitespace
   #+begin_src emacs-lisp
     (use-package whitespace
       :ensure t
       :demand t
       :delight
       :bind ("C-c W" . whitespace-cleanup)
       :custom
       (whitespace-style '(face trailing tabs spaces empty space-mark tab-mark))
       (whitespace-display-mappings '((space-mark ?\u3000 [?\u25a1])
                                      ;; (tab-mark ?\t [?\u00BB ?\t] [?\\ ?\t])
                                      ))
       (whitespace-space-regexp  "\\(\u3000+\\)")
       (whitespace-global-modes  '(not dired-mode tar-mode magit-mode))
       (global-whitespace-mode t)
       (whitespace-action '(auto-cleanup))
       :config
       ;; (set-face-attribute 'whitespace-trailing nil
       ;;                     :background "Black"
       ;;                     :foreground "DeepPink"
       ;;                     :underline t)
       (set-face-attribute 'whitespace-tab nil
                           :background nil
                           :foreground "LightSkyBlue"
                           :underline t)
       ;; (set-face-attribute 'whitespace-space nil
       ;;                     :background "Black"
       ;;                     :foreground "GreenYellow"
       ;;                     :weight 'bold)
       ;; (set-face-attribute 'whitespace-empty nil
       ;;                     :background "Black")
       (advice-add 'org-edit-src-save :before (lambda () (whitespace-cleanup)))
       (advice-add 'org-edit-src-exit :before (lambda () (whitespace-cleanup)))
       :hook (org-src-mode-hook . whitespace-turn-on))
   #+end_src
* UI
** Clipboard
   #+begin_src emacs-lisp
     (use-package emacs
       :bind ("M-w" . region-to-clipboard)
       :config
       (defun yank-to-clipboard ()
         "Copy the most recently killed text to the system clipboard with OSC 52."
         (interactive)
         (let ((base64_text (base64-encode-string (encode-coding-string (substring-no-properties (nth 0 kill-ring)) 'utf-8) t)))
           (send-string-to-terminal (format "\033]52;c;%s\a" base64_text))))

       (defun region-to-clipboard ()
         "Copy the selected region to both the kill-ring and clipboard with OSC 52."
         (interactive)
         (if (region-active-p)
             (let* ((selected-text (buffer-substring-no-properties (region-beginning) (region-end)))
                    (base64_text (base64-encode-string (encode-coding-string selected-text 'utf-8) t)))
               (if (display-graphic-p)
                   (clipboard-kill-ring-save (region-beginning) (region-end))
                 (kill-new selected-text)
                 (send-string-to-terminal (format "\033]52;c;%s\a" base64_text))))
           (message "No region selected."))))
   #+end_src
** Mouse / touchpad
   #+begin_src emacs-lisp
     (use-package disable-mouse
       :ensure t
       :if (display-graphic-p)
       :config
       (global-disable-mouse-mode))
   #+end_src
** Wayland / x11
   #+begin_src emacs-lisp
     (when (memq  window-system '(pgtk x))
       (setq x-super-keysym 'meta))
   #+end_src
** mac
   #+begin_src emacs-lisp
     (use-package mac
       :when (eq 'mac window-system)
       :init
       (set-frame-parameter nil 'ns-appearance 'dark)
       :custom
       (mac-control-modifier 'control)
       (mac-option-modifier 'super)
       (mac-command-modifier 'meta)
       (mac-right-control-modifier. 'control)
       (mac-right-option-modifier 'hyper)
       (mac-right-command-modifier'meta))
   #+end_src
** ns
   #+begin_src emacs-lisp
     (use-package ns
       :if (eq 'ns window-system)
       :init
       (set-frame-parameter nil 'ns-appearance 'dark)
       :custom
       (ns-control-modifier 'control)
       (ns-option-modifier 'super)
       (ns-command-modifier 'meta)
       (ns-right-control-modifier 'control)
       (ns-right-option-modifier 'hyper)
       (ns-right-command-modifier 'meta)
       (ns-function-modifier 'super))
   #+end_src
** language
   #+begin_src emacs-lisp
     (use-package mule
       :init
       (set-language-environment "Japanese")
       (prefer-coding-system 'utf-8))
   #+end_src
** skk
   #+begin_src emacs-lisp
     (use-package ddskk
       :ensure t
       :bind* (("C-j" . skk-kakutei)
               ("C-x @ j" . skk-kakutei)) ;; for ctrl-j from wezterm
       :custom
       (default-input-method "japanese-skk")
       (skk-byte-compile-init-file t)
       :init
       (setq skk-user-directory (expand-file-name "ddskk.d" user-emacs-directory))
       (setq skk-init-file (expand-file-name "init.el" skk-user-directory ))
       (when (file-directory-p my:d:nextcloud)
         (setq skk-jisyo (cons (expand-file-name "personal_config/skk/ddskk/skk-jisyo.utf8" my:d:nextcloud) 'utf-8))
         )
       (setq viper-mode nil))
   #+end_src
** puni
   #+begin_src emacs-lisp
     (use-package puni
       :ensure t
       :defer t
       :bind ("C-h" . puni-backward-delete-char)
       :init
       (puni-global-mode)
       (add-hook 'term-mode-hook #'puni-disable-puni-mode)
       :custom
       (electric-pair-mode t))
      #+end_src
** Completion UI
*** vertico
     #+begin_src emacs-lisp
       (use-package vertico
         :ensure t
         :init
         (vertico-mode)
         :custom
         (vertico-count 20)
         (enable-recursive-minibufferst)
         (vertico-cycle t)
         :bind (nil
                :map vertico-map
                ("C-r" . vertico-previous)
                ("C-s" . vertico-next)))

       (use-package vertico-directory
         :ensure nil ;; part of vertico
         :after vertico
         :commands (vertico-directory-tidy)
         :bind (nil
                :map vertico-map
                ("RET" . vertico-directory-enter)
                ("C-l" . vertico-directory-up)))
     #+end_src
*** consult
    #+begin_src emacs-lisp
      (use-package consult
        :ensure t
        :demand t
        :bind (("C-s" . consult-line)
               ("C-c M-x" . consult-mode-command)
               ("C-c h" . consult-history)
               ([remap Info-search] . consult-info)
               ("C-x 4 b" . consult-buffer-other-window)
               ("C-x 5 b" . consult-buffer-other-frame)
               ("C-x t b" . consult-buffer-other-tab)
               ("C-x r b" . consult-bookmark)
               ("C-x p b" . consult-project-buffer)
               ;; Other custom bindings
               ("M-y" . consult-yank-pop)
               ;; M-g bindings in `goto-map'
               ("M-g e" . consult-compile-error)
               ("M-g f" . consult-flycheck)
               ("M-g g" . consult-goto-line)
               ("M-g M-g" . consult-goto-line)
               ("M-g o" . consult-outline)
               ("M-g m" . consult-mark)
               ("M-g k" . consult-global-mark)
               ("M-g i" . consult-imenu)
               ("M-g I" . consult-imenu-multi)
               ;; M-s bindings in `search-map'
               ("M-s d" . consult-fd)
               ("M-s c" . consult-locate)
               ("M-s g" . consult-grep)
               ("M-s G" . consult-git-grep)
               ("M-s r" . consult-ripgrep)
               ("M-s l" . consult-line)
               ("M-s L" . consult-line-multi)
               ("M-s k" . consult-keep-lines)
               ("M-s u" . consult-focus-lines)
               ;; Isearch integration
               ("M-s e" . consult-isearch-history)
               :map isearch-mode-map
               ("M-e" . consult-isearch-history)
               ("M-s e" . consult-isearch-history)
               ("M-s l" . consult-line)
               ("M-s L" . consult-line-multi)
               ;; Minibuffer history
               :map minibuffer-local-map
               ("M-s" . consult-history)
               ("M-r" . consult-history))
        :bind* (("C-c C-a" . consult-buffer)
                ("C-z" . consult-imenu))
        :hook (completion-list-mode . consult-preview-at-point-mode)
        :init
        (setq xref-show-xrefs-function #'consult-xref
              xref-show-definitions-function #'consult-xref)
        :custom
        (recentf-mode t)
        :config
        (require 'keymap) ;; keymap-substitute requires emacs version 29.1?
        (require 'cl-seq)
        (keymap-substitute project-prefix-map #'project-find-regexp #'consult-ripgrep)
        (cl-nsubstitute-if
         '(consult-ripgrep "Find regexp")
         (pcase-lambda (`(,cmd _)) (eq cmd #'project-find-regexp))
         project-switch-commands))
    #+end_src
*** marginalia
    #+begin_src emacs-lisp
      (use-package marginalia
        :ensure t
        :init
        (marginalia-mode))
    #+end_src
*** orderless
    #+begin_src emacs-lisp
      (use-package orderless
        :ensure t
        :custom
        (completion-styles '(orderless))
        (completion-category-overrides nil))
    #+end_src
*** fussy
    #+begin_src emacs-lisp
      (use-package fussy
        :ensure t
        :config
        (push 'fussy completion-styles))
    #+end_src
*** embark
    #+begin_src emacs-lisp
      (use-package embark
        :ensure t
        :bind ("C-." . embark-act))

      (use-package embark-consult
        :ensure t
        :hook (embark-collect-mode-hook . consult-preview-at-point-mode))
    #+end_src
*** tempel
    #+begin_src emacs-lisp
      (use-package tempel
        :ensure t
        ;; :bind (nil
        ;;        :map tempel-map
        ;;        ("C-i" . tempel-next)
        ;;        )
        :init
        (defun tempel-setup-capf ()
          (setq-local completion-at-point-functions
                      (cons #'tempel-complete
                            completion-at-point-functions)))
        (add-hook 'prog-mode-hook 'tempel-setup-capf)
        (add-hook 'text-mode-hook 'tempel-setup-capf)
        (add-hook 'org-mode-hook 'tempel-setup-capf))
    #+end_src
*** corfu
    #+begin_src emacs-lisp
      (use-package corfu-terminal
        :ensure t
        :if (not (display-graphic-p))
        :config
        (corfu-terminal-mode +1))

      (use-package corfu
        :ensure t
        :custom ((corfu-auto t)
                 (corfu-auto-prefix 1)
                 (corfu-auto-delay 0)
                 (corfu-cycle t))
        :init
        (global-corfu-mode)
        (corfu-popupinfo-mode))

      (use-package cape
        :ensure t
        :init
        ;; Add `completion-at-point-functions', used by `completion-at-point'.
        (add-to-list 'completion-at-point-functions #'cape-file)
        (add-to-list 'completion-at-point-functions #'cape-dabbrev)
        ;;(add-to-list 'completion-at-point-functions #'cape-history)
        (add-to-list 'completion-at-point-functions #'cape-keyword)
        ;; (add-to-list 'completion-at-point-functions #'cape-tex)
        ;;(add-to-list 'completion-at-point-functions #'cape-sgml)
        ;;(add-to-list 'completion-at-point-functions #'cape-rfc1345)
        ;;(add-to-list 'completion-at-point-functions #'cape-abbrev)
        ;;(add-to-list 'completion-at-point-functions #'cape-ispell)
        ;;(add-to-list 'completion-at-point-functions #'cape-dict)
        ;;(add-to-list 'completion-at-point-functions #'cape-symbol)
        ;;(add-to-list 'completion-at-point-functions #'cape-line)
      )
    #+end_src
** which-key
   #+begin_src emacs-lisp
     (use-package which-key
       :ensure t
       :delight
       :custom
       ((which-key-idle-delay  1)
        (which-key-replacement-alist  '(((nil . "Prefix Command") . (nil . "prefix"))
                                        ((nil . "\\`\\?\\?\\'") . (nil . "lambda"))
                                        (("<left>") . ("←"))
                                        (("<right>") . ("→"))
                                        (("<\\([[:alnum:]-]+\\)>") . ("\\1"))))
        (which-key-mode t)))
   #+end_src
** ace-window
   #+begin_src emacs-lisp
     (use-package ace-window
       :ensure t
       :bind ("C-x o" . ace-window)
       :custom
       (aw-keys '(?j ?k ?l ?i ?o ?h ?y ?u ?p))
       ;; :custom-face
       ;; (aw-leading-char-face . '((t
       ;;                             (:height 4.0
       ;;                                      :foreground "#f1fa8c"))))
       )
   #+end_src
** breadcrumb
   #+begin_src emacs-lisp
     (use-package breadcrumb
       :ensure t
       :custom (breadcrumb-mode t))
   #+end_src

** undo
   #+begin_src emacs-lisp
     (use-package vundo
       :ensure t
       :bind ("C-x u" . vundo))
   #+end_src
** mwim
   #+begin_src emacs-lisp
     (use-package mwim
       :ensure t
       :bind (("C-a" . mwim-beginning-of-code-or-line)
              ("C-e" . mwim-end-of-code-or-line)))
   #+end_src
** dmacro
   #+begin_src emacs-lisp
     (use-package dmacro
       :ensure t
       :delight
       :custom
       (dmacro-key (kbd "C-t"))
       :config
       (global-dmacro-mode))
   #+end_src
* Garbage collection
  #+begin_src emacs-lisp
    (setq gc-cons-threshold most-positive-fixnum)
    (add-hook 'emacs-startup-hook
              (lambda ()
                (setq gc-cons-threshold (* 124 1024 1024))))

    (setq gc-cons-percentage 0.2
          garbage-collection-messages t)
    (run-with-idle-timer 60 t #'garbage-collect)
  #+end_src
* LSP
** eglot
   #+begin_src emacs-lisp
     (use-package eglot
       ;; :bind (nil
       ;;        :map eglot-mode-map
       ;;        ("C-c a" . eglot-code-actions))
       :config
       (defun my/eglot-capf ()
         (setq-local completion-at-point-functions
                     (list (cape-capf-super
                            #'tempel-complete
                            #'eglot-completion-at-point)
                           #'cape-keyword
                           #'cape-dabbrev
                           #'cape-file)
                     ))
       (add-hook 'eglot-managed-mode-hook #'my/eglot-capf))

     (use-package flycheck-eglot
       :ensure t
       :after (flycheck eglot)
       :custom (flycheck-eglot-exclusive nil)
       :config
       (global-flycheck-eglot-mode 1))

     (use-package jsonrpc
       :ensure t
       :defer t
       :config
       (setq jsonrpc-default-request-timeout 3000)
       (fset #'jsonrpc--log-event #'ignore))

     (use-package eglot-booster
       :vc (:url "https://github.com/jdtsmith/eglot-booster" :rev :newest)
       :after eglot
       :config
       (eglot-booster-mode))
   #+end_src
** Flymake
   #+begin_src emacs-lisp
     ;; (use-package flymake
     ;;   :ensure t
     ;;   :bind (nil
     ;;          :map flymake-mode-map
     ;;          ("C-c C-p" . flymake-goto-prev-error)
     ;;          ("C-c C-n" . flymake-goto-next-error))
     ;;   ;; :config
     ;;   ;; (set-face-background 'flymake-errline "red4")
     ;;   ;; (set-face-background 'flymake-warnline "DarkOrange")
     ;;   )

     ;; (use-package flymake-diagnostic-at-point
     ;;   :ensure t
     ;;   :after flymake
     ;;   :config
     ;;   (add-hook 'flymake-mode-hook #'flymake-diagnostic-at-point-mode)
     ;;   (remove-hook 'flymake-diagnostic-functions 'flymake-proc-legacy-flymake))
   #+end_src
** Flycheck
   #+begin_src emacs-lisp
     (use-package flycheck
       :ensure t
       :custom
       (flycheck-display-errors-delay 0.3)
       (flycheck-textlint-plugin-alist ())
       :init
       (global-flycheck-mode)
       :config
       (setq-default flycheck-indication-mode 'left-margin)
       (add-hook 'flycheck-mode-hook #'flycheck-set-indication-mode))

     (use-package flycheck-inline
       :ensure t
       :hook (flycheck-mode-hook . flycheck-inline-mode))
   #+end_src
* Writing
** Spell Checker
*** jinx
    This uses natively-compiled code, I install this alongside emacs via nix.
    #+begin_src emacs-lisp
      (use-package jinx
        :hook ((org-mode-hook markdown-mode-hook) . my:jinx-mode-enable)
        :bind (("C-;" . jinx-correct)
               ("C-x @ ;" . jinx-correct) ; for wezterm
               ("C-M-$" . jinx-languages))
        :init
        (defun my:jinx-mode-enable ()
          "Enable jinx mode if the current buffer does not contain Hiragana characters."
          (interactive)
          (unless (save-excursion
                    (goto-char (point-min))
                    (search-forward-regexp "[あ-ん]" nil t))
            (jinx-mode))))
    #+end_src
* Programming
** General
*** makefile
    #+begin_src emacs-lisp
      (use-package makefile-mode
        :mode ("\\Makefile\\'" . makefile-mode)
        :hook (makefile-mode-hook . (lambda ()
                                      (setq tab-width 4))))
    #+end_src
*** tree-sitter
    #+begin_src emacs-lisp
      (use-package treesit
        :custom
        (treesit-font-lock-level 3)
        :config
        (setq major-mode-remap-alist
              '((yaml-mode . yaml-ts-mode)
                (json-mode . json-ts-mode)
                (toml-mode . toml-ts-mode)
                (bash-mode . bash-ts-mode)
                (js2-mode . js-ts-mode)
                (typescript-mode . typescript-ts-mode)
                (tsx-mode . tsx-ts-mode)
                (css-mode . css-ts-mode)
                (cmake-mode . cmake-ts-mode)
                (dockerfile-mode . dockerfile-ts-mode)
                (rust-mode . rust-ts-mode)
                (lua-mode . lua-ts-mode)
                (python-mode . python-ts-mode))))
    #+end_src
*** git
    #+begin_src emacs-lisp
      (use-package git-modes :ensure t)

      (use-package magit
        :ensure t
        :custom
        (magit-wip-mode t)
        :bind (("C-x g" . magit-status)
               ("C-x M-g" . magit-dispatch-popup)))

      (use-package diff-hl
        :ensure t
        :demand t
        :config
        (global-diff-hl-mode)
        (diff-hl-margin-mode)
        :hook ((magit-pre-refresh-hook . diff-hl-magit-pre-refresh)
               (magit-post-refresh-hook . diff-hl-magit-post-refresh)
               (dired-mode-hook . diff-hl-dired-mode)))
    #+end_src
** languages
*** emacs lisp
    #+begin_src emacs-lisp
      (use-package aggressive-indent
        :ensure t
        :hook (emacs-lisp-mode-hook . aggressive-indent-mode))

      (use-package highlight-defined
        :ensure t
        :hook (emacs-lisp-mode-hook . highlight-defined-mode))

      (use-package highlight-quoted
        :ensure t
        :hook (emacs-lisp-mode-hook . highlight-quoted-mode))
    #+end_src
*** Shell Script
    #+begin_src emacs-lisp
      (use-package sh-script
        :hook (bash-ts-mode-hook . eglot-ensure))
    #+end_src
*** Nix
    #+begin_src emacs-lisp
      (use-package nix-mode
        :ensure t
        :mode "\\.nix\\'")
    #+end_src
*** Python
    #+begin_src emacs-lisp
      (use-package python
        :custom
        (python-indent-guess-indent-offset-verbose . nil)
        (flycheck-python-ruff-config '("ruff.toml" ".ruff.toml"))
        :hook (python-ts-mode-hook . eglot-ensure))

      (use-package reformatter
        :ensure t
        :hook ((python-ts-mode-hook . ruff-format-on-save-mode)
               (python-ts-mode-hook . ruff-fix-on-save-mode))
        :config
        (reformatter-define ruff-format
          :program "ruff"
          :args `("format" "--stdin-filename" ,buffer-file-name "-"))
        (reformatter-define ruff-fix
          :program "ruff"
          :args `("check" "--fix" "-e" "--stdin-filename" ,buffer-file-name  "-")
          :group 'python))

      ;; (use-package flymake-ruff
      ;;   :ensure t
      ;;   :hook (eglot-managed-mode-hook . (lambda ()
      ;;                                      (when (derived-mode-p 'python-mode 'python-ts-mode)
      ;;                                        (flymake-ruff-load))))
      ;;   :config
      ;;   (setq flymake-ruff--default-configs '("ruff.toml" ".ruff.toml")))

      ;; (use-package ruff-fix
      ;;   :vc (:url "https://github.com/mkt3/ruff-fix.el.git" :rev :newest)
      ;;   ;; :vc (:fetcher github :repo mkt3/ruff-fix.el.git)
      ;;   :hook (before-save-hook . ruff-fix-before-save))
    #+end_src
*** Rust
    #+begin_src emacs-lisp
      (use-package rust-mode
        :ensure t
        :custom rust-format-on-save t
        :hook (rust-ts-mode-hook . eglot-ensure))

      (use-package cargo
        :ensure t
        :hook (rust-ts-mode-hook . cargo-minor-mode))
    #+end_src
*** Lua
    #+begin_src emacs-lisp
      (use-package lua-mode
        :ensure t
        :custom (lua-indent-level 2))
    #+end_src
*** web
**** web-mode
     #+begin_src emacs-lisp
       (use-package web-mode
         :ensure t
         :mode ("\\.css\\'" "\\.p?html?\\'")
         :custom
         (web-mode-markup-indent-offset 2)
         (web-mode-css-indent-offset 2)
         (web-mode-code-indent-offset 2)
         (web-mode-comment-style 2)
         (web-mode-style-padding 1)
         (web-mode-script-padding 1)
         (web-mode-enable-auto-closing t)
         (web-mode-enable-auto-pairing t)
         (web-mode-auto-close-style 2)
         (web-mode-tag-auto-close-style 2)
         (indent-tabs-mode nil)
         (tab-width 2))
     #+end_src
*** typescript / JavaScript
**** node module path
     #+begin_src emacs-lisp
       (use-package  add-node-modules-path
         :ensure t
         :commands add-node-modules-path)
     #+end_src
**** jsx-mode
     #+begin_src emacs-lisp
       (use-package jtsx
         :ensure t
         :mode (("\\.jsx?\\'" . jtsx-jsx-mode)
                ("\\.tsx\\'" . jtsx-tsx-mode)
                ("\\.ts\\'" . jtsx-typescript-mode))
         :commands jtsx-install-treesit-language
         :hook ((jtsx-jsx-mode . hs-minor-mode)
                (jtsx-tsx-mode . hs-minor-mode)
                (jtsx-typescript-mode . hs-minor-mode))
         :custom
         (js-indent-level 2)
         (typescript-ts-mode-indent-offset 2)
         (jtsx-switch-indent-offset 0)
         (jtsx-indent-statement-block-regarding-standalone-parent nil)
         (jtsx-jsx-element-move-allow-step-out t)
         (jtsx-enable-jsx-electric-closing-element t)
         :config
         (defun jtsx-bind-keys-to-mode-map (mode-map)
           "Bind keys to MODE-MAP."
           (keymap-set mode-map "C-c C-j" 'jtsx-jump-jsx-element-tag-dwim)
           (keymap-set mode-map "C-c j o" 'jtsx-jump-jsx-opening-tag)
           (keymap-set mode-map "C-c j c" 'jtsx-jump-jsx-closing-tag)
           (keymap-set mode-map "C-c j r" 'jtsx-rename-jsx-element)
           (keymap-set mode-map "C-c <down>" 'jtsx-move-jsx-element-tag-forward)
           (keymap-set mode-map "C-c <up>" 'jtsx-move-jsx-element-tag-backward)
           (keymap-set mode-map "C-c C-<down>" 'jtsx-move-jsx-element-forward)
           (keymap-set mode-map "C-c C-<up>" 'jtsx-move-jsx-element-backward)
           (keymap-set mode-map "C-c C-S-<down>" 'jtsx-move-jsx-element-step-in-forward)
           (keymap-set mode-map "C-c C-S-<up>" 'jtsx-move-jsx-element-step-in-backward)
           (keymap-set mode-map "C-c j w" 'jtsx-wrap-in-jsx-element))

         (defun jtsx-bind-keys-to-jsx-mode-map ()
           (jtsx-bind-keys-to-mode-map jsx-mode-map))

         (defun jtsx-bind-keys-to-tsx-mode-map ()
           (jtsx-bind-keys-to-mode-map tsx-mode-map))

         (add-hook 'jsx-mode-hook 'jtsx-bind-keys-to-jsx-mode-map)
         (add-hook 'tsx-mode-hook 'jtsx-bind-keys-to-tsx-mode-map))
     #+end_src
**** typescript-mode
     #+begin_src emacs-lisp
       (use-package typescript-mode
         :ensure t
         :custom
         (typescript-indent-level 2)
         :hook (typescript-ts-mode-hook . (lambda ()
                                            (interactive)
                                            (add-node-modules-path)
                                            (eglot-ensure))))
     #+end_src
** Markup Languages
*** Org
**** org-mode
     #+begin_src emacs-lisp
       (use-package org
         :bind (("C-c l" . org-store-link)
                :map org-mode-map
                ("C-c C-o" . my:org-open-url-with-default)
                ("C-c i t" . org-insert-structure-template)
                ("C-c C-'" . org-edit-special)
                :map org-src-mode-map
                ("C-c C-'" . org-edit-src-exit))
         :init
         (setq org-directory my:d:org)
         (setq org-latex-create-formula-image-program 'dvisvgm)
         :custom
         (org-startup-indent nil)
         ;; (org-startup-numerated t)
         (org-hide-leading-stars t)
         (org-return-follows-link t)
         (org-startup-truncated nil)
         (org-use-speed-commands t)
         (org-startup-with-latex-preview nil)
         (org-log-done 'time)
         (org-adapt-indentation t)
         (org-confirm-babel-evaluate nil)
         :config
         (defun org-insert-clipboard-image ()
           "Generate png file from a clipboard image and insert a link to current buffer."
           (interactive)
           (let* ((filename
                   (concat (file-name-nondirectory (buffer-file-name))
                           "_image/"
                           (format-time-string "%Y%m%d_%H%M%S")
                           ".png")))
             (unless (file-exists-p (file-name-directory filename))
               (make-directory (file-name-directory filename)))
             (shell-command (concat "pngpaste " filename))
             (if (file-exists-p filename)
                 (insert (concat "[[file:" filename "]]")))
             (org-display-inline-images)))
         (bind-key "C-M-y" 'org-insert-clipboard-image)

         (defun my:org-open-url-with-default ()
           (interactive)
           (let ((browse-url-browser-function 'browse-url-default-browser))
             (org-open-at-point)))
         (advice-add 'org-edit-special :before (lambda (&rest args) (read-only-mode -1)))
         (defun my:enable-read-only ()
           "Enable read-only mode for certain conditions."
           (when (or (save-excursion
                       (goto-char (point-min))
                       (search-forward " -*- buffer-read-only: t -*-" nil t))
                     (and (buffer-file-name)
                          (string-match-p "/roam/config/" (buffer-file-name))))
             (read-only-mode 1)))
         (advice-add 'org-edit-src-exit :after #'my:enable-read-only)

         (org-babel-do-load-languages
          'org-babel-load-languages
          '((emacs-lisp . t)
            (python . t)
            (shell . t))))

       (use-package org-appear
         :ensure t
         :after org
         :hook (org-mode-hook . org-appear-mode)
         :custom
         (org-hide-emphasis-markers t)
         (org-appear-inside-latex   t)
         (org-appear-autosubmarkers t))

       (use-package org-web-tools
         :ensure t
         :bind
         ("C-c i l" . org-web-tools-insert-link-for-url))

       ;; (use-package org-sticky-header
       ;;   :ensure t
       ;;   :hook (org-mode-hook . org-sticky-header-mode))
     #+end_src
**** org gtd
     #+begin_src emacs-lisp
       (use-package org-agenda
         :after org
         :if (file-directory-p my:d:org-gtd)
         :bind (("C-c d" . org-agenda)
                ("C-c g" . gtd)
                :map org-mode-map
                ("C-c C-w" . org-refile))
         :init
         (defvar org-gtd-file (expand-file-name "gtd.org" my:d:org-gtd))

         (defun gtd ()
           (interactive)
           (find-file org-gtd-file))
         (when (display-graphic-p)
           (run-at-time 0 (* 5 60)
                        (lambda ()
                          (start-process "copy-calendar" nil "bash" (expand-file-name "personal_config/calendar/copy_calendar.sh" my:d:nextcloud)))))
         :custom
         (org-agenda-window-setup 'other-tab)
         (org-agenda-span 'day)
         (org-agenda-remove-tags t)
         (org-agenda-current-time-string "← now ───────────────────")
         (org-agenda-todo-ignore-scheduled 'feature)
         (org-agenda-skip-deadline-prewarning-if-scheduled t)
         (org-todo-keywords '((sequence "TODO(t)" "IN PROGRESS(i)" "|" "DONE(d)")
                              (sequence "WAITING(w)" "SOMEDAY(s)" "|" "CANCELLED(c/!)")))
         (org-agenda-custom-commands '(("t" todo "TODO")
                                       ("A" todo)))
         :config
         (setq org-overriding-columns-format "%ITEM %Effort{:} %CLOCKSUM %PRIORITY")
         (add-to-list 'org-modules 'org-habit t)
         (setq org-agenda-prefix-format
               '((agenda . " %i %-15:c%?-12t% s")
                 (todo . " %i %-12:c")
                 (tags . " %i %-12:c")
                 (search . " %i %-12:c")))

         (setq my:roam-task-tag "todo")
         (defun my:org-roam-todo-entry-p ()
           "Return non-nil if current buffer has any todo entry."
           (seq-find (lambda (type) (eq type 'todo))
                     (org-element-map (org-element-parse-buffer 'headline)
                         'headline
                       (lambda (h)
                         (org-element-property :todo-type h)))))
         (defun my:org-roam-note-buffer-p ()
           "Return non-nil if the currently visited buffer is an Org Roam note."
           (and buffer-file-name
                (string-prefix-p (expand-file-name (file-name-as-directory org-roam-directory))
                                 (file-name-directory buffer-file-name))))

         (defun my:org-roam-update-task-tag ()
           "Update `my:roam-task-tag' in the current buffer."
           (when (and (not (active-minibuffer-window))
                      (my:org-roam-note-buffer-p))
             (save-excursion
               (goto-char (point-min))
               (if (my:org-roam-todo-entry-p)
                   (org-roam-tag-add (list my:roam-task-tag))
                 (org-roam-tag-remove (list my:roam-task-tag))))))

         (defun my:org-roam-get-task-files ()
           "Return a list of note files containing 'my:roam-task-tag'."
           (seq-uniq
            (mapcar 'car
                    (org-roam-db-query
                     [:select [nodes:file]
                              :from tags
                              :left-join nodes
                              :on (= tags:node-id nodes:id)
                              :where (like tag $s1)] (concat "%" my:roam-task-tag "%")))))

         (defun my:org-agenda-update-files (&rest _)
           "Update the value of `org-agenda-files' and and `my:refile-targets'."
           (let ((task-files (my:org-roam-get-task-files)))
             (setq org-agenda-files (append (list my:d:org-gtd) task-files))
             (setq my:refile-targets (append (list org-gtd-file) task-files))
             (setq org-refile-targets '((my:refile-targets :maxlevel . 1)))))

         (add-hook 'before-save-hook #'my:org-roam-update-task-tag)
         (advice-add 'org-agenda :before #'my:org-agenda-update-files)
         (advice-add 'org-todo-list :before #'my:org-agenda-update-files)
         (advice-add 'org-refile :before #'my:org-agenda-update-files)

         ;; (defun update-org-agenda-buffer ()
         ;;   "Update the *Org Agenda* buffer if it exists."
         ;;   (when (get-buffer "*Org Agenda*")
         ;;     (with-current-buffer "*Org Agenda*"
         ;;       (let ((current-position (point)))
         ;;         (org-agenda-redo)
         ;;         (goto-char current-position)))))

         ;; (defun safe-update-org-agenda-buffer ()
         ;;   "Safely update the *Org Agenda* buffer and handle any errors."
         ;;   (condition-case err
         ;;       (update-org-agenda-buffer)
         ;;     (error (message "Error updating *Org Agenda*: %s" (error-message-string err)))))
         ;; (run-with-timer 0 60 'safe-update-org-agenda-buffer)

         (defvar org-clock-current-task-file
           (expand-file-name "org-clock-current-task.txt" user-emacs-directory))

         (defun org-clock-current-task-to-file ()
           (with-temp-file org-clock-current-task-file
             (insert (or org-clock-current-task ""))))

         (defun org-clock-clear-file-after-clock-out ()
           (with-temp-file org-clock-current-task-file
             (insert "")))

         (add-hook 'org-clock-in-hook 'org-clock-current-task-to-file)
         (add-hook 'org-clock-out-hook 'org-clock-clear-file-after-clock-out)

         (add-hook 'org-after-todo-state-change-hook
                   'org-clock-todo-change)
         (defun org-clock-todo-change ()
           (if (string= org-state "IN PROGRESS")
               (org-clock-in)
             (org-clock-out)))
         )

       (use-package org-super-agenda
         :ensure t
         :after (org-agenda)
         :if (file-directory-p my:d:org-gtd)
         :config
         (org-super-agenda-mode)
         (setq org-super-agenda-groups
                '(;; Each group has an implicit boolean OR operator between its selectors.
                  (:name "Schedule"
                         :time-grid t
                         :todo "TODAY")
                  (:name "Today's daily task"
                         :habit t
                         :order 1)
                  (:name "Important"
                         :priority "A"
                         :order 2)
                  (:priority<= "B"
                               :order 3)
                  (:todo "WAITING" :order 8)
                  (:todo "SOMEDAY" :order 9)
                  (:auto-category t
                                  :order 4))))

       (use-package org-capture
         :after (org org-agenda)
         :if (file-directory-p my:d:org-gtd)
         :commands (org-capture)
         :bind ("C-c c" . org-capture)
         :init
         :config
         (setq org-capture-templates `(("i" " Inbox" entry (file+headline org-gtd-file "Inbox")
                                        "** %^{Brief Description}"))))
      #+end_src
**** org-roam
     #+begin_src emacs-lisp
       (use-package org-roam
         :ensure t
         :after org
         :demand t
         :if (file-directory-p my:d:org-roam)
         :bind (("C-c n a" . org-roam-alias-add)
                ("C-c n f" . my:org-roam-node-find-excluding-dir)
                ("C-c n 0" . my:org-roam-node-find-in-dir)
                ("C-c n i" . org-roam-node-insert)
                ("C-c n o" . org-id-get-create)
                ("C-c n t" . org-roam-tag-add)
                ("C-c n r" . org-roam-ref-add)
                ("C-c n l" . org-roam-buffer-toggle)
                ("C-c n c" . citar-insert-citation)
                ("C-c n j" . org-roam-dailies-capture-today)
                ("C-c n d" . org-roam-dailies-find-date)
                ("C-c n e" . org-roam-extract-subtree)
                ("C-c n p" . citar-open)
                ("C-c C-g t" . org-roam-dailies-find-today))
         :init
         (setq org-roam-directory my:d:org-roam)
         (setq org-roam-dailies-directory "daily_notes/")
         ;; (setq org-format-latex-options (plist-put org-format-latex-options :foreground 'auto))
         (setq org-format-latex-options (plist-put org-format-latex-options :background "Transparent"))
         (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.5))
         :custom
         (org-roam-capture-templates '(("n" "note" plain "%?"
                                        :if-new
                                        (file+head "note/${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n#+hugo_draft: true\n\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("j" "project" plain "%?"
                                        :if-new
                                        (file+head "project/${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n* Tasks\n\n* Work log\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("0" "zero second thinking" plain "%?"
                                        :if-new
                                        (file+head "zero_second_thinking/%<%Y%m%d>_${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n* \n* \n* \n*")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("b" "book" plain "%?"
                                        :if-new
                                        (file+head "reference/book/${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n* Link\n  - \n* Facts\n\n* Interpretations\n\n* Actions\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("w" "web" plain "%?"
                                        :if-new
                                        (file+head "reference/web/${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("c" "config" plain "%?"
                                        :if-new
                                        (file+head "config/${slug}.org.gpg"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("r" "record" plain "%?"
                                        :if-new
                                        (file+head "record/${slug}.org.gpg"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ("m" "memo" plain "%?"
                                        :if-new
                                        (file+head "memo/${slug}.org"
                                                   "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n")
                                        :immediate-finish t
                                        :unnarrowed t)
                                       ))
         :config
         (load (expand-file-name "personal_config/emacs/journal.el" my:d:nextcloud))
         (defun my:org-roam-read-only ()
           "Enable read-only mode for org-roam files."
           (when (and (buffer-file-name)
                      (string-match-p "/roam/config/" (buffer-file-name)))
             (read-only-mode 1)))
         (add-hook 'org-mode-hook 'my:org-roam-read-only)
         (add-hook 'org-mode-hook (lambda ()
                                    (setq-local time-stamp-active t
                                                time-stamp-line-limit 18
                                                time-stamp-start "^#\\+last_modified: [ \t]*"
                                                time-stamp-end "$"
                                                time-stamp-format "\[%Y-%m-%d %a %H:%M\]")
                                    (add-hook 'before-save-hook 'time-stamp nil 'local)))
         (cl-defmethod org-roam-node-type ((node org-roam-node))
           "Return the TYPE of NODE."
           (condition-case nil
               (file-name-nondirectory
                (directory-file-name
                 (file-name-directory
                  (file-relative-name (org-roam-node-file node) org-roam-directory))))
             (error "")))
         (setq org-roam-node-display-template
               (concat "${type:22} ${title:60} " (propertize "${tags:30}" 'face 'org-tag)))
         (org-roam-db-autosync-enable)

         (defun my:org-roam-node-filter (node dir &optional exclude)
           "Filter org-roam nodes by directory.
       If EXCLUDE is non-nil, exclude nodes in DIR, otherwise include only nodes in DIR."
           (let ((dir (file-truename (expand-file-name dir my:d:org-roam))))
             (if exclude
                 (not (string-prefix-p dir (file-truename (org-roam-node-file node))))
               (string-prefix-p dir (file-truename (org-roam-node-file node))))))

         (defun my:org-roam-node-find-in-dir ()
           "Find and open an Org-roam node in the specified directory."
           (interactive)
           (org-roam-node-find nil nil
                               (lambda (node) (my:org-roam-node-filter node "zero_" nil))))

         (defun my:org-roam-node-find-excluding-dir ()
           "Find and open an Org-roam node, excluding nodes in a specific directory."
           (interactive)
           (org-roam-node-find nil nil
                               (lambda (node) (my:org-roam-node-filter node "zero_" t)))))

       (use-package org-roam-ui
         :ensure t
         :after org-roam
         :config
         (setq org-roam-ui-sync-theme t
               org-roam-ui-follow t
               org-roam-ui-update-on-save t
               org-roam-ui-open-on-start t))

       (use-package consult-org-roam
         :ensure t
         :init
         (consult-org-roam-mode 1)
         :custom
         (consult-org-roam-grep-func #'consult-ripgrep)
         :bind (("C-c n b" . consult-org-roam-backlinks)
                ("C-c n g" . consult-org-roam-search)))

       (use-package citar
         :ensure t
         :if (file-exists-p my:f:bib)
         :custom
         (citar-bibliography my:f:bib)
         (citar-file-open-functions '(("html" . citar-file-open-external) (t . find-file))))

       (use-package citar-embark
         :ensure t
         :after citar embark
         :no-require
         :config
         (setq citar-at-point-function 'embark-act)
         (citar-embark-mode))

       (use-package citar-org-roam
         :ensure t
         :after (citar org-roam)
         :if (file-exists-p my:f:bib)
         :config
         (citar-org-roam-mode)
         (setq citar-org-roam-template-fields (append citar-org-roam-template-fields '((:citar-file . ("file")) (:citar-abstract . ("abstract")))))
         (setq citar-org-roam-note-title-template "${title}")
         (setq org-roam-capture-templates
               (append org-roam-capture-templates
                       '(("p" "paper" plain "%?"
                          :if-new
                          (file+head "reference/paper/${citar-citekey}.org" "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n* Comment\n\n* Abstract\n  ${citar-abstract}\n\n* Memo\n  :PROPERTIES:\n  :NOTER_DOCUMENT: ~/Nextcloud/zotero/${citar-file}\n  :END:\n")
                          :immediate-finish t
                          :unnarrowed t))))
         (setq citar-org-roam-capture-template-key "p"))

       (use-package org-noter
         :ensure t
         :custom
         (org-noter-supported-modes '(doc-view-mode pdf-view-mode nov-mode))
         (org-noter-highlight-selected-text t))
     #+end_src
**** ox-hugo
     #+begin_src emacs-lisp
       (use-package ox-hugo
         :ensure t
         :after org
         :if (and (file-directory-p my:d:org-roam)
                  (file-directory-p my:d:org-hugo))
         :custom
         (org-hugo-base-dir my:d:org-hugo)
         (org-hugo-default-section-directory "notes")
         :config
         (defun org-hugo-set-slug-if-absent (draft-position)
           "Set the Hugo slug from the ID if it's not already set."
           (goto-char (point-min))
           (unless (re-search-forward "^#\\+hugo_slug:" nil t)
             (when (re-search-forward ":ID: +\\([a-zA-Z0-9-]+\\)" nil t)
               (let ((id (match-string 1)))
                 (goto-char draft-position)
                 (forward-line)
                 (insert (concat "#+hugo_slug: " id "\n"))))))

         (defun org-hugo-replace-last-modified ()
           "Replace last_modified with hugo_lastmod."
           (goto-char (point-min))
           (while (re-search-forward "^#\\+last_modified:" nil t)
             (replace-match "#+hugo_lastmod:")))

         (defun org-hugo-export-drafts ()
           "Export all non-draft .org files in my:d:org-roam to markdown using org-hugo."
           (interactive)
           (let ((recentf-active recentf-mode))
             (when recentf-active
               (recentf-mode -1))
             (dolist (org-file (directory-files-recursively (expand-file-name "note" my:d:org-roam) "\\.org$"))
               (with-current-buffer (find-file-noselect org-file nil t nil)
                 (save-excursion
                   (goto-char (point-min))
                   (let ((draft-position (re-search-forward "^#\\+hugo_draft: false$" nil t))
                         (modified (buffer-modified-p)))
                     (when draft-position
                       (org-hugo-set-slug-if-absent draft-position)
                       (org-hugo-replace-last-modified)
                       (org-hugo-export-to-md)
                       (set-buffer-modified-p modified))))
                 (kill-buffer)))
             (when recentf-active
               (recentf-mode 1)))))
     #+end_src
**** org-pomodoro
     #+begin_src emacs-lisp
       (use-package org-pomodoro
         :ensure t
         :custom
         (org-pomodoro-length 50)
         (org-pomodoro-short-break-length 10))
     #+end_src
*** Markdown
    #+begin_src emacs-lisp
      (use-package markdown-mode
        :ensure t
        :mode (("\\.md\\'" . markdown-mode)
               ("\\.markdown\\'" . markdown-mode)
               (("README\\.md\\'" . gfm-mode)))
        :custom
        (markdown-fontify-code-blocks-natively t)
        (markdown-indent-on-enter 'indent-and-new-item)
        :hook (markdown-mode-hook . (lambda ()
                                       (setq tab-width 2)
                                       (turn-on-orgtbl)
                                       (add-to-list 'eglot-server-programs '(markdown-mode . ("marksman")))
                                       (eglot-ensure))))
    #+end_src
*** YAML
    #+begin_src emacs-lisp
      (use-package yaml-mode
        :ensure t
        :mode (("\\.yml\\'" . yaml-ts-mode)
               ("\\.yaml\\'" . yaml-ts-mode))
        :commands (yaml-ts-mode))
    #+end_src
*** TOML
    #+begin_src emacs-lisp
      (use-package toml-mode
        :ensure t
        :mode (("\\.toml\\'" . toml-ts-mode))
        :commands (toml-ts-mode))
    #+end_src
*** JSON
    #+begin_src emacs-lisp
      (use-package json-mode
        :ensure t
        :mode (("\\.json\\'" . json-ts-mode))
        :commands (json-ts-mode)
        :hook (json-ts-mode-hook . eglot-ensure))
      (use-package json-reformat
        :ensure t
        :after (json-ts-mode))
    #+end_src
*** EPUB
     #+begin_src emacs-lisp
       (use-package nov
         :ensure t
         :if (display-graphic-p)
         :mode (("\\.epub\\'" . nov-mode))
         :hook (nov-mode-hook . visual-line-mode)
         :config
         (setq nov-text-width t))
     #+end_src
* Tramp
  #+begin_src emacs-lisp
    (use-package tramp
      :init
      (setq tramp-remote-path '(tramp-default-remote-path
                                "~/.local/bin/"))
      (add-to-list 'tramp-remote-path 'tramp-own-remote-path)
      (setq tramp-default-method "ssh")
      (setq tramp-auto-save-directory
            (expand-file-name "tramp-auto-save" user-emacs-directory))
      (setq tramp-persistency-file-name
            (expand-file-name "tramp-connection-history" user-emacs-directory))
      (setq password-cache-expiry nil)
      :config
      ; https://github.com/alexluigit/dirvish/blob/main/docs/CUSTOMIZING.org#tramp-integration
      (add-to-list 'tramp-connection-properties
                   (list (regexp-quote "/ssh:")
                         "direct-async-process" t))
      (setq tramp-verbose 0)
      (setq tramp-chunksize 2000)
      (setq tramp-use-ssh-controlmaster-options nil)
      (customize-set-variable 'tramp-ssh-controlmaster-options
                              (concat
                               "-o ControlPath=/tmp/ssh-tramp-%%r@%%h:%%p "
                               "-o ControlMaster=auto -o ControlPersist=yes")))
  #+end_src
* Filer
  #+begin_src emacs-lisp
    (use-package dired
      :custom
      (dired-dwim-target t)
      (dired-recursive-copies 'always)
      :bind (nil
             :map dired-mode-map
             ("[" . dired-prev-subdir)
             ("]" . dired-next-subdir)))

    (use-package casual-dired
      :ensure t
      :bind (nil
             :map
             dired-mode-map
             ("M-o" . casual-dired-tmenu)))
  #+end_src
* Browser
  #+begin_src emacs-lisp
    (use-package eww
      :demand t
      :bind (nil
             :map eww-mode-map
             ("h" . eww-back-url)
             ("l" . eww-forward-url)
             ("o" . eww-browse-with-external-browser)
             ("r" . eww-reload)
             ("y" . eww-copy-page-down)
             ("j" . scroll-up-line)
             ("k" . scroll-down-line)
             ("g" . beginning-of-buffer)
             (";" . quit-window)
             ("G" . end-of-buffer))
      :custom
      (browse-url-browser-function 'eww-browse-url)
      (eww-search-prefix "https://www.google.com/search?q=")
      ;; (browse-url-browser-function 'eww)
      :config
      (defun eww-disable-images ()
        (interactive)
        (setq-local shr-put-image-function 'shr-put-image-alt)
        (eww-reload))
      (defun eww-enable-images ()
        (interactive)
        (setq-local shr-put-image-function 'shr-put-image)
        (eww-reload))
      (defun shr-put-image-alt (spec alt &optional flags)
        (insert alt)))
#+end_src
* Rss
  #+begin_src emacs-lisp
    (use-package elfeed
      :after eww
      :ensure t
      :if (file-directory-p my:d:nextcloud)
      :bind (("C-x w" . elfeed)
             :map elfeed-search-mode-map
             ("u" . elfeed-search-fetch)
             ("r" . elfeed-search-update--force)
             ("o" . elfeed-search-browse-url)
             (";" . elfeed-search-quit-window)
             ("m" . elfeed-search-show-entry)
             ("," . elfeed-search-first-entry)
             ("." . elfeed-search-last-entry)
             :map elfeed-show-mode-map
             ("r" . elfeed-search-update--force)
             ("u" . elfeed-search-fetch)
             ("o" . elfeed-show-visit)
             ("C-c C-o" . my:elfeed-show-default-browser)
             (";" . elfeed-kill-buffer))
      :custom
      (elfeed-db-directory (locate-user-emacs-file "elfeed"))
      :config
      (advice-add 'elfeed-search-fetch :after (lambda (&rest _) (message "RSS fetch completed.")))
      (defun my:elfeed-show-default-browser ()
               (interactive)
               (let ((browse-url-browser-function 'browse-url-default-browser))
                 (elfeed-show-visit))))

    (use-package elfeed-protocol
      :ensure t
      :if (file-directory-p my:d:nextcloud)
      :after elfeed
      :config
      (elfeed-protocol-enable)
      :custom
      (elfeed-use-curl t)
      (elfeed-set-timeout 36000)
      (elfeed-log-level 'debug)
      (elfeed-protocol-fever-update-unread-only t)
      :config
      (setq elfeed-protocol-feeds
            (list (let ((auth-info (nth 0 (auth-source-search :host "freshrss" :max 1))))
                    (list (plist-get auth-info :feed-url)
                          :api-url (plist-get auth-info :api-url)
                          :password (plist-get auth-info :password))))))

    (use-package elfeed-webkit
      :ensure t
      :after elfeed
      :config
      :bind (nil
             :map elfeed-webkit-map
             ("k" . (lambda () (interactive) (xwidget-webkit-scroll-down 20)))
             ("j" . (lambda () (interactive) (xwidget-webkit-scroll-up 20)))
             :map elfeed-show-mode-map
             ("i" . elfeed-webkit-toggle)))
  #+end_src
* Mail
  This uses natively-compiled code, I install this alongside emacs via nix.
** mu4e
   #+begin_src emacs-lisp
     (use-package mu4e
       :if (and (executable-find "mu") (file-directory-p "~/.config/mu4e") (display-graphic-p))
       :demand t  ; load-path has already been set by nix
       :bind (("C-c m" . mu4e)
              :map mu4e-minibuffer-search-query-map
              ("C-j" . skk-kakutei)
              :map mu4e-thread-mode-map
              ("C-<tab>" . tab-next)
              ("C-i" . mu4e-thread-fold-toggle)
              :map mu4e-view-mode-map
              ("C-m" . browse-url-at-point)
              ("C-c C-o" . my:browse-url-at-point-with-default-browser))
       :config
       (defun my:browse-url-at-point-with-default-browser ()
         (interactive)
         (let ((link (get-text-property (point) 'shr-url))
               (browse-url-browser-function 'browse-url-default-browser))
           (if link
               (shr-browse-url)
             (when (thing-at-point 'url)
               (browse-url (thing-at-point 'url))))))
       (setq mu4e-headers-auto-update t)
       (setq mu4e-headers-skip-duplicates t)
       (setq mu4e-headers-sort-field :date)
       (setq mu4e-index-cleanup t)
       (setq mu4e-update-interval 300)
       (setq mu4e-attachment-dir "~/Downloads")
       (setq mu4e-change-filenames-when-moving t)
       (setq mu4e-confirm-quit nil)
       (setq mu4e-headers-visible-lines 20)
       (setq mu4e-hide-index-messages t)
       (setq message-citation-line-format "%N @ %Y-%m-%d %H:%M :\n")
       ;; M-x find-function RET message-citation-line-format for docs:
       (setq message-citation-line-function 'message-insert-formatted-citation-line)
       (setq mu4e-headers-include-related nil)
       (setq mu4e-context-policy 'pick-first)
       (setq mu4e-compose-context-policy 'ask-if-none)
       ;; https://github.com/djcb/mu/issues/1136#issuecomment-1229005006
       (setf (plist-get (alist-get 'trash mu4e-marks) :action)
             (lambda (docid msg target)
               (mu4e--server-move docid (mu4e--mark-check-target target) "-N"))) ; Instead of "+T-N"
       ;; for sending mails
       (require 'smtpmail)
       ;; don't keep message compose buffers around after sending:
       (setq message-kill-buffer-on-exit t)
       (setq sendmail-program "msmtp"
             send-mail-function 'smtpmail-send-it
             message-sendmail-f-is-evil t
             message-sendmail-extra-arguments '("--read-envelope-from")
             message-send-mail-function 'message-send-mail-with-sendmail)
       (load "~/.config/mu4e/mu4e_config.el")
       (add-hook 'emacs-startup-hook  (lambda ()
                                        (my:imapnotify-start-prodigy-services)))
       (setq message-cite-reply-position 'bellow)
       ;; (defun message-insert-signature-at-point ()
       ;;   "Function to insert signature at point."
       ;;   (interactive)
       ;;   (message-goto-body)
       ;;   (save-restriction
       ;;     (narrow-to-region (point) (point))
       ;;     (message-insert-signature))
       ;;   (message-goto-body))
       ;; (add-hook 'mu4e-compose-mode-hook (lambda () (message-insert-signature-at-point)) t)
       ;; (add-hook 'mu4e-compose-pre-hook (lambda () (message-insert-signature-at-point t)) t)

       (add-hook 'mu4e-compose-mode-hook
                 (lambda()
                   (let* ((ctx (mu4e-context-current))
                          (mail (cdr (assoc 'user-mail-address (mu4e-context-vars ctx)))))
                     (when mail
                       (save-excursion
                         (message-add-header (concat "Bcc: " mail "\n")))))))

       (add-hook 'mu4e-compose-mode-hook (lambda ()
                                           (use-hard-newlines -1)
                                           (turn-off-auto-fill))))

     ;; (use-package mu4e-alert
     ;;   :ensure t
     ;;   :if (and (executable-find "mu") (file-directory-p my:d:nextcloud) (display-graphic-p))
     ;;   :custom
     ;;   (mu4e-alert-email-notification-types '(subjects))
     ;;   :config
     ;;   (if (eq system-type 'darwin) (mu4e-alert-set-default-style 'notifier) (mu4e-alert-set-default-style 'libnotify))
     ;;   (mu4e-alert-enable-mode-line-display)
     ;;   (mu4e-alert-enable-notifications))
   #+end_src
* Shell
  #+begin_src emacs-lisp
    (use-package eshell
      :custom
      (eshell-cmpl-ignore-case t)
      (eshell-cmpl-cycle-completions t)
      (shell-cmpl-cycle-cutoff-length 5)
      (eshell-ask-to-save-history (quote always))
      (eshell-hist-ignoredups t)
      (eshell-list-files-after-cd t)
      :bind (nil
             :map eshell-mode-map
             ("C-r" . consult-history))
      :config
      (add-hook 'eshell-mode-hook (lambda () (setenv "TERM" "xterm-256color")))
      (defun corfu-send-shell (&rest _)
        "Send completion candidate when inside comint/eshell."
        (cond
         ((and (derived-mode-p 'eshell-mode) (fboundp 'eshell-send-input))
          (eshell-send-input))
         ((and (derived-mode-p 'comint-mode)  (fboundp 'comint-send-input))
          (comint-send-input))))
      (advice-add #'corfu-insert :after #'corfu-send-shell))

    (use-package eshell-prompt-extras
      :ensure t
      :after esh-opt
      :defines eshell-highlight-prompt
      :commands (epe-theme-lambda epe-theme-dakrone epe-theme-multiline-with-status)
      :init (setq eshell-highlight-prompt nil
                  epe-path-style 'full
                  eshell-prompt-function 'epe-theme-multiline-with-status))

    (use-package eat
      :ensure t
      :hook (eshell-load-hook . eat-eshell-mode))
  #+end_src
* External Collaboration
** Pdf
   This uses natively-compiled code, I install this alongside emacs via nix.
   #+begin_src emacs-lisp
     (use-package pdf-tools
       :if (display-graphic-p)
       :demand t ; load-path has already been set by nix
       :commands (open-pdf-in-external-app)
       :hook (pdf-view-mode-hook . (lambda() (display-line-numbers-mode -1)))
       :bind (nil
              :map pdf-view-mode-map
              ("C-s" . isearch-forward)
              ("C-c C-o" . open-pdf-in-external-app))
       :config
       (pdf-loader-install)
       (setq-default pdf-view-display-size 'fit-page)
       (setq pdf-view-incompatible-modes '(linum-mode linum-relative-mode helm-linum-relative-mode nlinum-mode nlinum-hl-mode nlinum-relative-mode yalinum-mode))
       (setq pdf-annot-activate-created-annotations t)
       (defun open-pdf-in-external-app ()
         (interactive)
         (let ((pdf-file-path (buffer-file-name)))
           (start-process "open-pdf-external" nil "xdg-open" pdf-file-path))))
   #+end_src
** atomic-chrome
   #+begin_src emacs-lisp
     (use-package atomic-chrome
       :ensure t
       :if (display-graphic-p)
       :config
       (atomic-chrome-start-server))
   #+end_src
** dictionary
   #+begin_src emacs-lisp
     (use-package  mw-thesaurus
       :ensure t
       :bind ("C-c w" . mw-thesaurus-lookup-dwim))
   #+end_src
** prodigy
   #+begin_src emacs-lisp
     (use-package prodigy
       :ensure t
       :if (and (executable-find "goimapnotify") (file-directory-p my:d:nextcloud) (display-graphic-p))
       :after consult
       :config
       (add-to-list 'consult-buffer-filter "\\`\\*prodigy-.*\\*\\'")
       (load (expand-file-name "personal_config/emacs/mail/imapnotify.d/prodigy.el" my:d:nextcloud)))
  #+end_src
** openai
   #+begin_src emacs-lisp
     (use-package org-ai
       :ensure t
       :if (file-directory-p my:d:password-store)
       :commands (org-ai-mode
                  org-ai-global-mode)
       :init
       (add-hook 'org-mode-hook #'org-ai-mode) ; enable org-ai in org-mode
       (org-ai-global-mode) ; installs global keybindings on C-c M-a
       :config
       (setq org-ai-openai-api-token
             (plist-get (nth 0 (auth-source-search :app "openai" :max 1)) :api-key))
       (setq org-ai-default-chat-model "gpt-4o")
       (setq org-roam-capture-templates
             (append org-roam-capture-templates
                     '(("a" "ai" plain "%?"
                        :if-new
                        (file+head "reference/ai/${slug}.org" "#+title: ${title}\n#+date: %U\n#+last_modified: %U\n\n#+begin_ai\n[ME]: \n#+end_ai")
                        :immediate-finish t
                        :unnarrowed t)))))
   #+end_src
** Translate
   #+begin_src emacs-lisp
     (use-package go-translate
       :ensure t
       :bind (("C-c t" . gt-do-translate))
       :config
       (set-face-attribute 'gt-buffer-render-block-prefix-face nil :background "black")
       (setq gt-langs '(ja en))
       (setq engine-list (list
                          (gt-google-engine)
                          (gt-bing-engine)))
       (when (file-directory-p my:d:password-store)
         (let ((deeplapi-key (plist-get (nth 0 (auth-source-search :app "deepl" :max 1)) :api-key)))
           (setq engine-list (append (list (gt-deepl-engine :key deeplapi-key :pro nil)) engine-list))))
       (setq gt-default-translator
             (gt-translator
              :taker   (gt-taker :text 'word :pick 'paragraph)
              :engines engine-list
              :render  (gt-buffer-render)))
       (setq gts-buffer-follow-p t))

                                             ; https://github.com/lorniu/go-translate?tab=readme-ov-file
     ;; (use-package plz :ensure t)
   #+end_src
** recoll
   #+begin_src emacs-lisp
     (use-package consult-recoll
       :ensure t
       :demand t
       :if (executable-find "recoll")
       :bind (("C-c n s" . consult-recoll))
       :config
       (if (eq system-type 'darwin)
           (setq exec-path (append '("/usr/local/Cellar/recoll/1.35.0/recoll.app/Contents/MacOS") exec-path)))
       (when (display-graphic-p)
         (run-at-time 0 (* 5 60)
                      (lambda ()
                        (start-process "recollindex" nil "recollindex" "-c" (getenv "RECOLL_CONFDIR"))))))
   #+end_src
