#+title: Configurations for Emacs
#+author: Makoto Morinaga
#+startup: content
#+startup: nohideblocks

* Initialize
** Const
   #+begin_src emacs-lisp
     (defconst my:f:bib (expand-file-name "GoogleDrive/paperpile.bib" (getenv "HOME")))
     (defconst my:d:nextcloud (expand-file-name "Nextcloud" (getenv "HOME")))
     (defconst my:d:gtd (expand-file-name "gtd" my:d:nextcloud))
     (defconst my:d:org-roam (expand-file-name "org-roam" my:d:nextcloud))
     (defconst my:d:password-store (expand-file-name "password-store" my:d:nextcloud))
   #+end_src
** leaf
   #+begin_src emacs-lisp
     (eval-and-compile
       (customize-set-variable
        'package-archives '(("org" . "https://orgmode.org/elpa/")
                            ("melpa" . "https://melpa.org/packages/")
                            ("gnu" . "https://elpa.gnu.org/packages/")))
       (package-initialize)
       (unless (package-installed-p 'leaf)
         (package-refresh-contents)
         (package-install 'leaf))

       (leaf leaf-keywords
         :ensure t
         :init
         ;; optional packages if you want to use :hydra, :el-get, :blackout,,,
         (leaf hydra :ensure t)
         (leaf el-get :ensure t)
         (leaf blackout :ensure t)

         :config
         ;; initialize leaf-keywords.el
         (leaf-keywords-init)))
   #+end_src
** load Path
   #+begin_src emacs-lisp
     (leaf exec-path-from-shell
       :ensure t
       :when (memq window-system '(mac ns x))
       :defun (exec-path-from-shell-initialize)
       :custom ((exec-path-from-shell-arguments . "") ; zshの.zshrcでinteractiveのUIにしているため
                (exec-path-from-shell-variables . '("PATH" "GOPATH" "PLATFORM")))
       :config (exec-path-from-shell-initialize))
   #+end_src
** custom.el path
   #+begin_src emacs-lisp
     (leaf cus-edit
       :custom `((custom-file . ,(locate-user-emacs-file "custom.el"))))
   #+end_src

* buildin config
** customization propeties of buildins
   #+begin_src emacs-lisp
     (leaf cus-start
       :doc "define customization properties of builtins"
       :custom `((garbage-collection-messages     . t)
                 (gc-cons-threshold               . 100000000)
                 (fill-column                     . 65)
                 (tab-width                       . 4)
                 (create-lockfiles                . nil)
                 (make-backup-files               . nil)
                 (auto-save-default               . nil)
                 (use-dialog-box                  . nil)
                 (column-number-mode              . t)
                 (use-file-dialog                 . nil)
                 (frame-resize-pixelwise          . t)
                 (enable-recursive-minibuffers    . t)
                 (history-length                  . 1000)
                 (history-delete-duplicates       . t)
                 (scroll-preserve-screen-position . t)
                 (scroll-margin                   . 5)
                 (scroll-conservatively           . 1)
                 (next-screen-context-lines       . 5)
                 (mouse-wheel-scroll-amount       . '(1 ((control) . 5)))
                 (ring-bell-function              . 'ignore)
                 (text-quoting-style              . 'straight)
                 (truncate-lines                  . nil)
                 (truncate-partial-width-windows  . nil)
                 (menu-bar-mode                   . nil)
                 (tool-bar-mode                   . nil)
                 (scroll-bar-mode                 . nil)
                 (fringe-mode                     . 10)
                 (indent-tabs-mode                . nil)
                 (inhibit-startup-message         . t)
                 (inhibit-startup-screen          . t)
                 (gc-cons-threshold               . ,(* gc-cons-threshold 100))
                 (read-process-output-max         . ,(* 1024 1024)))
       :config
       (defalias 'yes-or-no-p 'y-or-n-p)
       (keyboard-translate ?\C-h ?\C-?))
   #+end_src

** default keybind
   #+begin_src emacs-lisp
     (leaf *default-keybind
       :bind (("M-+"   . text-scale-increase)
              ("M--"   . text-scale-decrease)
              ("C-c l" . toggle-truncate-lines)
              ("C-x |" . split-window-right)
              ("C-x -" . split-window-below)
              ("C-x x" . delete-window)))
   #+end_src

** lisp
   #+begin_src emacs-lisp
     (leaf simple
       :custom ((kill-ring-max                . 100)
                (kill-read-only-ok            . t)
                (kill-whole-line              . t)
                (eval-expression-print-length . nil)
                (eval-expression-print-lepvel . nil)))
     (leaf elisp-format
       :ensure t)
     (leaf abbrev
       :blackout (abbrev-mode . " Abv"))
     (leaf files
       :setq-default ((find-file-visit-truename . t)))
     (leaf display-line-numbers
       :config (global-display-line-numbers-mode)) ;; 行番号を常に表示
     (leaf delsel
       :custom ((delete-selection-mode . t)))
     (leaf uniquify
       :custom ((uniquify-buffer-name-style . 'post-forward-angle-brackets)
                (uniquify-min-dir-content . 1)
                (funiquify-ignore-buffers-re . "*[^*]+*")))
     (leaf time
       :custom ((display-time-string-forms . '(month "/" day "(" dayname ") " 24-hours ":" minutes))
                (display-time-mode . t)))
     (leaf autorevert
       :doc "revert buffers when files on disk change"
       :tag "builtin"
       :custom ((auto-revert-interval . 0.1))
       :global-minor-mode global-auto-revert-mode)
     (leaf autoinsert
       :doc "automatic mode-dependent insertion of text into new files"
       :custom ((auto-insert-mode . t)))
     (leaf paren
       :custom-face (show-paren-match . '((t
                                           (:weight regular
                                                    :background "#44475a"
                                                    :underline "$ffff00"))))
       :custom ((show-paren-delay . 0.0)
                (show-paren-mode  . t)))
     (leaf save-place-mode
       :doc "automatically save place in files"
       :custom ((save-place-mode . t)))
     (leaf windmove
       :custom (windmove-wrap-around . t)
       :bind (("C-M-h" . windmove-left)
              ("C-M-k" . windmove-up)
              ("C-M-j" . windmove-down)
              ("C-M-l" . windmove-right)))
     (leaf gcmh
       :ensure t
       :custom (gcmh-verbose . t)
       :config (gcmh-mode 1))
     (leaf recentf
       :ensure t
       :custom
       (recentf-exclude . '(".recentf"
                            "^/tmp\\.*"
                            "bookmarks"
                            "\\.*.calendar.ics")))
   #+end_src
** lisp/vc
   #+begin_src emacs-lisp
     (leaf vc-hooks
       :custom ((vc-follow-symlinks . t)))
   #+end_src

* color-theme
** doracula-theme
   #+begin_src emacs-lisp
     (leaf dracula-theme
       :ensure t
       :config
       (load-theme 'dracula t))
   #+end_src
** modus-theme
   #+begin_src emacs-lisp
     ;; (leaf *modus-themes
     ;;   :custom
     ;;   ((modus-themes-italic-constructs . t)
     ;;    (modus-themes-bold-constructs   . t)
     ;;    (modus-themes-region            . '(bg-only no-extend))
     ;;    (modus-themes-syntax            . '(faint))
     ;;    (modus-themes-diffs             . 'deuteranopia)
     ;;    )
     ;;   :config
     ;;   (load-theme 'modus-vivendi))
   #+end_src
* UI
** mac
   #+begin_src emacs-lisp
     (leaf mac
       :doc "implementation of gui terminal on macos"
       :doc "each symbol can be `control', `meta', `alt', `hyper', or `super'"
       :doc "`left' meens same value setting its left key"
       :when (eq 'mac window-system)
       :custom ((mac-control-modifier       . 'control)
                (mac-option-modifier        . 'super)
                (mac-command-modifier       . 'meta)
                (mac-right-control-modifier . 'control)
                (mac-right-option-modifier  . 'hyper)
                (mac-right-command-modifier . 'meta)))
   #+end_src
** ns
   #+begin_src emacs-lisp
     (leaf ns
       :doc "next/open/gnustep / macos communication module"
       :when (eq 'ns window-system)
       :custom ((ns-control-modifier       . 'control)
                (ns-option-modifier        . 'super)
                (ns-command-modifier       . 'meta)
                (ns-right-control-modifier . 'control)
                (ns-right-option-modifier  . 'hyper)
                (ns-right-command-modifier . 'meta)
                ;; use fn key as normal way.
                (ns-function-modifier      . 'super))
       :config (setq default-frame-alist (append '((inhibit-double-buffering . t)
                                                   (ns-appearance            . dark)
                                                   (ns-transparent-titlebar  . t))
                                                 default-frame-alist)))
   #+end_src
** language
   #+begin_src emacs-lisp
     (leaf *language
       :config (set-language-environment 'Japanese)
       (prefer-coding-system 'utf-8))
   #+end_src
** frame
   #+begin_src emacs-lisp
     (leaf *frame
       :init (setq default-frame-alist (append '((line-spacing         . 0  ) ; 文字間隔
                                                 (left-fringe          . 10 ) ; 左フリンジ幅
                                                 (right-fringe         . 11 ) ; 右フリンジ幅
                                                 (scroll-bar-width     . 17 ) ; スクロールバー幅
                                                 (cursor-type          . box) ; カーソル種別
                                                 (alpha                . 95 ) ; 透明度
                                                 ) default-frame-alist))
       :custom (initial-frame-alist . default-frame-alist)
       (frame-title-format . '("emacs " emacs-version (buffer-file-name " - %f"))) :bind(("C-c C-f" .
                                                                                            toggle-frame-maximized)))
   #+end_src
** font
   lsp-ui-sideline trauncate when font size is set to 20 or more.
   #+begin_src emacs-lisp
     (leaf *font
       :when window-system
       :config (add-to-list 'default-frame-alist '(font . "Cica-18")))
   #+end_src
* authentication
  #+begin_src emacs-lisp
    (leaf *authentication
      :if (file-directory-p my:d:password-store)
      :init
      (setq leaf-default-plstore (plstore-open (expand-file-name "plstore.plist" my:d:password-store)))
      (leaf plstore
        :custom
        :init
        (setq epa-pinentry-mode 'loopback)
        )
      )
  #+end_src
* minor-mode
** tab-bar-mode
   #+begin_src emacs-lisp
     (leaf tab-bar-mode
       :init (defvar my:ctrl-o-map (make-sparse-keymap)
               "My original keymap binded to C-o.")
       (defalias 'my:ctrl-o-prefix my:ctrl-o-map)
       (define-key global-map (kbd "C-o") 'my:ctrl-o-prefix)
       (define-key my:ctrl-o-map (kbd "c")   'tab-new)
       (define-key my:ctrl-o-map (kbd "C-c") 'tab-new)
       (define-key my:ctrl-o-map (kbd "k")   'tab-close)
       (define-key my:ctrl-o-map (kbd "C-k") 'tab-close)
       (define-key my:ctrl-o-map (kbd "n")   'tab-next)
       (define-key my:ctrl-o-map (kbd "C-n") 'tab-next)
       (define-key my:ctrl-o-map (kbd "p")   'tab-previous)
       (define-key my:ctrl-o-map (kbd "C-p") 'tab-previous)
       ;;
       (defun my:tab-bar-tab-name-truncated ()
         "Custom: Generate tab name from the buffer of the selected window."
         (let ((tab-name (buffer-name (window-buffer (minibuffer-selected-window))))
               (ellipsis (cond (tab-bar-tab-name-ellipsis)
                               ((char-displayable-p ?…) "…")
                               ("..."))))
           (if (< (length tab-name) tab-bar-tab-name-truncated-max)
               (format "%-12s" tab-name)
             (propertize (truncate-string-to-width tab-name tab-bar-tab-name-truncated-max nil
                                                   nil ellipsis) 'help-echo tab-name))))
       :custom ((tab-bar-close-button-show      . nil)
                (tab-bar-close-last-tab-choice  . nil)
                (tab-bar-close-tab-select       . 'left)
                (tab-bar-history-mode           . nil)
                (tab-bar-new-tab-choice         . "*scratch*")
                (tab-bar-new-button-show        . nil)
                (tab-bar-tab-name-function      . 'my:tab-bar-tab-name-truncated)
                (tab-bar-tab-name-truncated-max . 12)
                (tab-bar-separator              . ""))
       :config (tab-bar-mode +1))
   #+end_src
** dimmer
   #+begin_src emacs-lisp
     (leaf dimmer
       :ensure t
       :custom ((dimmer-fraction . 0.5)
                (dimmer-exclusion-regexp-list . '(".*Minibuf.*" ".*which-key.*" ".*NeoTree.*"
                                                  ".*Messages.*" ".*Async.*" ".*Warnings.*" ".*LV.*"
                                                  ".*Ilist.*"))
                (dimmer-mode . t)))
   #+end_src
** which-key
   #+begin_src emacs-lisp
     (leaf which-key
       :ensure t
       :custom ((which-key-idle-delay . 1)
                (which-key-replacement-alist . '(((nil . "Prefix Command") . (nil . "prefix"))
                                                 ((nil . "\\`\\?\\?\\'") . (nil . "lambda"))
                                                 (("<left>") . ("←"))
                                                 (("<right>") . ("→"))
                                                 (("<\\([[:alnum:]-]+\\)>") . ("\\1"))))
                (which-key-mode . t)))
   #+end_src
** smartparens
   #+begin_src emacs-lisp
     (leaf smartparens
       :ensure t
       :hook (after-init-hook . smartparens-global-strict-mode)
       :require smartparens-config
       :custom ((electric-pair-mode . nil)))
      #+end_src
** ace-window
   #+begin_src emacs-lisp
     (leaf ace-window
       :ensure t
       :bind (("C-x o" . ace-window))
       :custom ((aw-keys . '(?j ?k ?l ?i ?o ?h ?y ?u ?p)))
       :custom-face ((aw-leading-char-face . '((t
                                                (:height 4.0
                                                         :foreground "#f1fa8c"))))))
   #+end_src
** popwin
   #+begin_src emacs-lisp
     (leaf popwin
       :ensure t)
   #+end_src
** amx
   #+begin_src emacs-lisp
     (leaf amx
       :ensure t)
   #+end_src
** undo-tree
   #+begin_src emacs-lisp
     (leaf undo-tree
       :ensure t
       :leaf-defer nil
       :global-minor-mode global-undo-tree-mode
       :bind (  ("M-/" . undo-tree-redo))
       ;; :custom ((undo-tree-auto-save-history . t)
       ;;          (undo-tree-history-directory-alist . `(("." . ,(concat user-emacs-directory
       ;;                                                                 ".cache/undo-tree-hist/")))))
       )
   #+end_src
** whitespace
   #+begin_src emacs-lisp
     (leaf whitespace
       :ensure t
       :commands whitespace-mode
       :bind ("C-c W" . whitespace-cleanup)
       :custom ((whitespace-style . '(face trailing tabs spaces empty space-mark tab-mark))
                (whitespace-display-mappings . '((space-mark ?\u3000 [?\u25a1])
                                                 (tab-mark ?\t [?\u00BB ?\t]
                                                           [?\\ ?\t])))
                (whitespace-space-regexp . "\\(\u3000+\\)")
                (whitespace-global-modes . '(emacs-lisp-mode shell-script-mode sh-mode python-mode
                                                             org-mode markdown-mode rjsx-mode
                                                             css-mode))
                (global-whitespace-mode . t))
       :config (set-face-attribute 'whitespace-trailing nil
                                   :background "Black"
                                   :foreground "DeepPink"
                                   :underline t)
       (set-face-attribute 'whitespace-tab nil
                           :background "Black"
                           :foreground "LightSkyBlue"
                           :underline t)
       (set-face-attribute 'whitespace-space nil
                           :background "Black"
                           :foreground "GreenYellow"
                           :weight 'bold)
       (set-face-attribute 'whitespace-empty nil
                           :background "Black"))
   #+end_src
** mwim
   #+begin_src emacs-lisp
     (leaf mwim
       :ensure t
       :bind (("C-a" . mwim-beginning-of-code-or-line)
              ("C-e" . mwim-end-of-code-or-line)))
   #+end_src
** skk
   #+begin_src emacs-lisp
     (leaf skk
       :ensure ddskk
       :when window-system
       :defun (skk-get)
       :require t
       skk-study
       :bind (("C-x j"  . skk-mode))
       :custom ((skk-server-portnum . 1178)
                (skk-server-host . "localhost")
                (default-input-method . "japanese-skk"))
       :init (setq skk-user-directory (concat user-emacs-directory "ddskk.d"))
       (setq viper-mode nil)
       (setq skk-sticky-key ";")
       :hook ((lisp-interaction-mode-hook . (lambda()
                                              (progn (eval-expression (skk-mode) nil)
                                                     (skk-latin-mode (point)))))))
   #+end_src
** Complementaly UI
*** vertico
     #+begin_src emacs-lisp
       (leaf vertico
         :ensure t
         :global-minor-mode t
         :preface (defun my:filename-upto-parent ()
                    "Move to parent directory like \"cd ..\" in find-file."
                    (interactive)
                    (let ((sep (eval-when-compile (regexp-opt '("/" "\\")))))
                      (save-excursion (left-char 1)
                                      (when (looking-at-p sep)
                                        (delete-char 1)))
                      (save-match-data (when (search-backward-regexp sep nil t)
                                         (right-char 1)
                                         (filter-buffer-substring (point)
                                                                  (save-excursion (end-of-line)
                                                                                  (point)) #'delete)))))
         :custom ((vertico-count . 20)
                  (enable-recursive-minibuffers .t)
                  (vertico-cycle . t))
         :bind ((vertico-map ("C-r" . vertico-previous)
                             ("C-s" . vertico-next)
                             ("C-l" . my:filename-upto-parent)))
         :init (savehist-mode))
     #+end_src
*** consult
    #+begin_src emacs-lisp
      (leaf consult
        :ensure t
        :preface (defun my:consult-line
                     (&optional
                      at-point)
                   (interactive "P")
                   (if at-point (consult-line (thing-at-point 'symbol))
                     (consult-line)))
        :custom (recentf-mode . t)
        :bind* (("C-s" . my:consult-line)
                ("C-c C-a" . consult-buffer)
                ([remap goto-line] . consult-goto-line)
                ([remap yank-pop] . consult-yank-pop)))
    #+end_src
*** consult-lsp
    #+begin_src emacs-lisp
      (leaf consult-lsp
        :ensure t
        :bind (lsp-mode-map ([remap xref-apropos] . consult-lsp-symbols)))
    #+end_src
*** marginalia
    #+begin_src emacs-lisp
      (leaf marginalia
        :ensure t
        :global-minor-mode t)
    #+end_src
*** orderless
    #+begin_src emacs-lisp
      (leaf orderless
        :ensure t
        :custom (completion-styles . '(orderless)))
    #+end_src
*** embark
    #+begin_src emacs-lisp
      (leaf embark
        :ensure t
        :config (leaf embark-consult
                  :ensure t
                  :after (embark consult)))
    #+end_src
** company
   #+begin_src emacs-lisp
     (leaf company
       :ensure t
       :leaf-defer nil
       :blackout company-mode
       :bind ((company-active-map ("M-n" . nil)
                                  ("M-p" . nil)
                                  ("C-s" . company-filter-candidates)
                                  ("C-n" . company-select-next)
                                  ("C-p" . company-select-previous)
                                  ("C-i" . company-complete-common-or-cycle))
              (company-search-map ("C-n" . company-select-next)
                                  ("C-p" . company-select-previous)))
       :custom ((company-tooltip-limit             . 12)
                (company-idle-delay                . 0)
                (company-minimum-prefix-length     . 1)
                (company-transformers              . '(company-sort-by-occurrence))
                (global-company-mode               . t)
                (company-selection-wrap-around     . t)
                (vompany-tooltip-align-annotations . t)
                (company-backends . '(company-files
                                      company-capf
                                      (company-dabbrev-code
                                       company-gtags
                                       company-etags
                                       company-keywords)
                                      company-dabbrev)))
       :config (leaf company-prescient
                 :ensure t
                 :custom ((company-prescient-mode . t)))
       (leaf all-the-icons :ensure t)
       (leaf company-box
         :after all-the-icons
         :ensure t
         :hook ((company-mode-hook . company-box-mode))
         :custom (company-box-icons-alist    . 'company-box-icons-all-the-icons)
         )
       (leaf company-quickhelp
         :when (display-graphic-p)
         :ensure t
         :custom ((company-quickhelp-delay . 0.8)
                  (company-quickhelp-mode  . t))
         :bind (company-active-map ("M-h" . company-quickhelp-manual-begin))
         :hook ((company-mode-hook . company-quickhelp-mode)))
       (leaf company-math
         :ensure t
         :defvar (company-backends)
         :preface (defun c/latex-mode-setup ()
                    (setq-local company-backends (append '((company-math-symbols-latex
                                                            company-math-symbols-unicode
                                                            company-latex-commands)) company-backends)))
         :hook ((org-mode-hook . c/latex-mode-setup)
                (tex-mode-hook . c/latex-mode-setup))))
   #+end_src
** yasnippet
   #+begin_src emacs-lisp
     (leaf yasnippet
       :ensure t
       :blackout yas-minor-mode
       :custom ((yas-indent-line . 'fixed)
                (yas-global-mode . t))
       :bind ((yas-keymap ("<tab>" . nil)) ; conflict with company
              (yas-minor-mode-map ("C-c y i" . yas-insert-snippet)
                                  ("C-c y n" . yas-new-snippet)
                                  ("C-c y v" . yas-visit-snippet-file)
                                  ("C-c y l" . yas-describe-tables)
                                  ("C-c y g" . yas-reload-all)))
       :config (leaf yasnippet-snippets
                 :ensure t)
       (leaf yatemplate
         :ensure t
         :config (yatemplate-fill-alist))
       (defvar company-mode/enable-yas t
         "Enable yasnippet for all backends.")
       (defun company-mode/backend-with-yas (backend)
         (if (or (not company-mode/enable-yas)
                 (and (listp backend)
                      (member 'company-yasnippet backend))) backend (append (if (consp backend) backend (list backend))
                                                                            '(:with company-yasnippet ))))
       (defun set-yas-as-company-backend ()
         (setq company-backends (mapcar #'company-mode/backend-with-yas company-backends)))
       :hook ((company-mode-hook . set-yas-as-company-backend)))
   #+end_src
** highlight-indent-gide
   #+begin_src emacs-lisp
     (leaf highlight-indent-guides
       :ensure t
       :blackout t
       :hook (((prog-mode-hook yaml-mode-hook) . highlight-indent-guides-mode))
       :custom ((highlight-indent-guides-method       . 'character) ;; fill,column,character
                (highlight-indent-guides-auto-enabled . t) ;; automatically calculate faces.
                (highlight-indent-guides-responsive   . t)
                (highlight-indent-guides-character    . ?\|)))
   #+end_src
** imenu-list
   #+begin_src emacs-lisp
     (leaf imenu-list
       :ensure t
       :bind (("C-z" . imenu-list-smart-toggle))
       :custom-face (imenu-list-entry-face-1 . '((t
                                                  (:foreground "white"))))
       :custom ((imenu-list-focus-after-activation . t)
                (imenu-list-auto-resize            . t)))
   #+end_src
** rainbow-delimiters
   #+begin_src emacs-lisp
     (leaf rainbow-delimiters
       :ensure t
       :hook ((prog-mode-hook . rainbow-delimiters-mode)))
   #+end_src
** nyan-mode
   #+begin_src emacs-lisp
     (leaf nyan-mode
       :ensure t
       :init
       (nyan-mode 1))
   #+end_src
** projectile
   #+begin_src emacs-lisp
     (leaf projectile
       :ensure t
       :init
       :config (setq projectile-mode-line-prefix " Prj")
       (projectile-mode +1)
       :custom ((projectile-mode-line-prefix . " Prj"))
       :bind (projectile-mode-map ("C-c p" . projectile-command-map)))
   #+end_src
** flycheck
   #+begin_src emacs-lisp
     (leaf flycheck
       :ensure t
       :hook (prog-mode-hook . flycheck-mode)
       :custom ((flycheck-display-errors-delay . 0.3)
                (flycheck-indication-mode . 'left-margin)
                )
       :config
       (add-hook 'flycheck-mode-hook #'flycheck-set-indication-mode)
       ;; (leaf flycheck-inline
       ;;   :ensure t
       ;;   :hook (flycheck-mode-hook . flycheck-inline-mode))
       )
     ;; (flycheck-define-checker textlint
     ;;   "A linter for Markdown."
     ;;   :command ("textlint.sh" source)
     ;;   :error-patterns
     ;;   ((warning line-start (file-name) ":" line ":" column ": "
     ;;             (id (one-or-more (not (any " "))))
     ;;             (message (one-or-more not-newline)
     ;;                      (zero-or-more "\n" (any " ") (one-or-more not-newline)))
     ;;             line-end))
     ;;   :modes (text-mode markdown-mode gfm-mode org-mode))
   #+end_src
** tree-sitter
   #+begin_src emacs-lisp
     (leaf tree-sitter
       :ensure t
       :init
       (leaf tree-sitter-langs :ensure t)
       (global-tree-sitter-mode)
       :hook (tree-sitter-after-on-hook . tree-sitter-hl-mode)
       )
   #+end_src
** node module path
   #+begin_src emacs-lisp
     (leaf add-node-modules-path
       :ensure t
       :commands add-node-modules-path)
   #+end_src
** tramp
   #+begin_src emacs-lisp
     (leaf tramp
       :ensure t
       :init
       ;; Disable version control on tramp buffers to avoid freezes.
       (setq vc-ignore-dir-regexp
             (format "\\(%s\\)\\|\\(%s\\)"
                     vc-ignore-dir-regexp
                     tramp-file-name-regexp))
       (setq tramp-default-method "ssh")
       (setq tramp-auto-save-directory
             (expand-file-name "tramp-auto-save" user-emacs-directory))
       (setq tramp-persistency-file-name
             (expand-file-name "tramp-connection-history" user-emacs-directory))
       (setq password-cache-expiry nil)
       (setq tramp-use-ssh-controlmaster-options nil)
       :config
       (customize-set-variable 'tramp-ssh-controlmaster-options
                               (concat
                                "-o ControlPath=/tmp/ssh-tramp-%%r@%%h:%%p "
                                "-o ControlMaster=auto -o ControlPersist=yes"))
       (with-eval-after-load 'lsp-mode
         (lsp-register-client
          (make-lsp-client :new-connection (lsp-tramp-connection "pyright")
                           :major-modes '(python-mode)
                           :remote? t
                           :server-id 'pyright-remote))
         )
       )
   #+end_src
* major-mode
** lsp-mode
   #+begin_src emacs-lisp
     (leaf lsp-mode
       :ensure t
       :commands (lsp lsp-deferred)
       :config
       :custom ((lsp-completion-provider            . :none)
                (lsp-keymap-prefix                  . "C-c l")
                (lsp-log-io                         . t)
                (lsp-eldoc-render-all               . t)
                (lsp-keep-workspace-alive           . nil)
                (lsp-document-sync-method           . 2)
                (lsp-response-timeout               . 5)
                (lsp-headerline-breadcrumb-icons-enable . nil)
                (lsp-enable-file-watchers           . nil))
       :hook (lsp-mode-hook . lsp-headerline-breadcrumb-mode)
       :init (leaf lsp-ui
               :ensure t
               :after lsp-mode
               :custom ((lsp-ui-doc-enable            . t)
                        (lsp-ui-doc-position          . 'at-point)
                        (lsp-ui-doc-header            . t)
                        (lsp-ui-doc-include-signature . t)
                        (lsp-ui-doc-max-width         . 150)
                        (lsp-ui-doc-max-height        . 30)
                        (lsp-ui-doc-show-with-cursor  . t)
                        (lsp-ui-peek-enable           . t)
                        (lsp-ui-peek-peek-height      . 20)
                        (lsp-ui-peek-list-width       . 50)
                        (lsp-ui-doc-enable            . nil)
                        (lsp-ui-sideline-enable       . t)
                        (lsp-ui-sideline-show-code-actions . t)
                        (lsp-ui-sideline-show-diagnostics . t)
                        (lsp-ui-sideline-diagnostic-max-lines . 30)
                        (lsp-ui-sideline-show-hover . t)
                        )
               :bind ((lsp-ui-mode-map ([remap xref-find-definitions] .
                                        lsp-ui-peek-find-definitions)
                                       ([remap xref-find-references] .
                                        lsp-ui-peek-find-references))
                      (lsp-mode-map ("C-c s" . lsp-ui-sideline-mode)
                                    ("C-c d" . lsp-ui-doc-mode)))
               :hook ((lsp-mode-hook . lsp-ui-mode))))
   #+end_src
** grammarly
   #+begin_src emacs-lisp
     (leaf lsp-grammarly
       :when (string= "osx" (getenv "PLATFORM"))
       :ensure t
       ;; :el-get
       ;; (emacs-grammarly/lsp-grammarly :type github :checkout "1e2aff23dfaf419bfae66718761a0eddbd6f613e")
       :hook
       ((text-mode-hook org-mode-hook markdown-mode-hook) . (lambda ()
                                                              (require 'lsp-grammarly)
                                                              (lsp-deferred)))
       )
   #+end_src
** python-mode
   #+begin_src emacs-lisp
     (leaf *python
       :custom (python-indent-guess-indent-offset-verbose . nil)
       :config
       (leaf lsp-pyright
         :ensure t
         ;; :init (setq lsp-pyright-typechecking-mode "strict")
         :hook (python-mode-hook . (lambda ()
                                     (require 'lsp-pyright)
                                     (lsp-deferred))))
       (leaf py-isort
         :ensure t
         :custom (py-isort-options . '("--profile=black"))
         )
       (leaf blacken
         :ensure t
         :custom ((blacken-line-length . 119)
                  (blacken-skip-string-normalization . t)))
       (leaf ein
         :ensure t))
   #+end_src
** yaml-mode
   #+begin_src emacs-lisp
     (leaf yaml-mode
       :ensure t)
   #+end_src
** toml-mode
   #+begin_src emacs-lisp
     (leaf toml-mode
       :ensure t)
   #+end_src
** json-reformat
   #+begin_src emacs-lisp
     (leaf json-reformat
       :ensure t)
   #+end_src
** scss-mode
   #+begin_src emacs-lisp
     (leaf scss-mode
       :ensure t
       :hook ((scss-mode-hook . (lambda ()
                                  (and
                                   (set (make-local-variable 'css-indent-offset) 2)
                                   (set (make-local-variable 'scss-compile-at-save) nil))))))
   #+end_src
** rjsx-mode
   #+begin_src emacs-lisp
          (leaf rjsx-mode
            :ensure t
            :mode ("\\.jsx\\'" "\\.js\\'")
            :custom ((indent-tabs-mode . nil)
                     (js-indent-level . 2)
                     (js2-strict-missing-semi-waring . nil)
                     (js2-mode-show-strict-warnings . nil))
            :config
            :hook (rjsx-mode-hook . (lambda ()
                                      (add-node-modules-path)
                                      (flycheck-mode t))))
   #+end_src
** tide
   #+begin_src emacs-lisp
     (leaf tide
       :ensure t
       :commands tide-setup)
   #+end_src
** typescript-mode
   #+begin_src emacs-lisp
     (leaf typescript-mode
       :ensure t
       :defun flycheck-add-mode
       :custom ((typescript-indent-level . 2))
       :config (flycheck-add-mode 'javascript-eslint 'web-mode)
       :hook (typescript-mode-hook . (lambda ()
                                       (interactive)
                                       (add-node-modules-path)
                                       (flycheck-mode +1)
                                       (tide-setup)
                                       (eldoc-mode +1)
                                       (tide-hl-identifier +1)
                                       (company-mode +1)
                                       (setq flycheck-checker 'javascript-eslint))))
   #+end_src
** org-mode
   #+begin_src emacs-lisp
     (leaf org
       :ensure t
       :preface
       (defvar org-gtd-file (expand-file-name "gtd.org" my:d:gtd))
       (defun gtd ()
         (interactive)
         (find-file org-gtd-file))
       :if (file-directory-p my:d:gtd)
       ;; :hook ((org-mode-hook . (lambda ()
       ;;                           (setq flycheck-checker 'textlint)
       ;;                           (flycheck-mode 1))))
       :bind (("C-c c" . org-capture)
              ("C-c a" . org-agenda)
              ("C-c g" . gtd)
              ("C-c C-'" . org-edit-special)
              (org-src-mode-map ("C-c C-'" . org-edit-src-exit))
              )
       :advice (:before org-calendar-holiday
                        (lambda ()
                          (require 'japanese-holidays)))
       :init
       (setq org-directory my:d:gtd)
       (setq org-agenda-files (list org-directory))
       (setq org-latex-create-formula-image-program 'dvisvgm)
       :custom ((org-refile-targets . '((org-agenda-files :maxlevel . 1)))
                (org-agenda-current-time-string . "now ============")
                (org-startup-indent . nil)
                (org-hide-leading-stars . t)
                (org-return-follows-link . t)
                (org-startup-truncated . nil)
                (org-use-speed-commands . t)
                (org-log-done . t)
                (org-adapt-indentation . t)
                (org-todo-keywords . '((sequence "TODO(t)" "IN PROGRESS(i)" "|" "DONE(d)")
                                       (sequence "WAITING(w@/!)" "CANCELLED(c@/!)" "SOMEDAY(s)")))
                (org-todo-keyword-faces . '(("TODO" :foreground "red"
                                             :weight bold)
                                            ("STARTED" :foreground "cornflower blue"
                                             :weight bold)
                                            ("DONE" :foreground "green"
                                             :weight bold)
                                            ("WAITING" :foreground "orange"
                                             :weight bold)
                                            ("CANCELLED" :foreground "green"
                                             :weight bold))))
       :config
       (add-hook 'org-mode-hook (lambda ()
                                  (setq-local time-stamp-active t
                                              time-stamp-line-limit 18
                                              time-stamp-start "^#\\+last_modified: [ \t]*"
                                              time-stamp-end "$"
                                              time-stamp-format "\[%Y-%m-%d %a %H:%M\]")
                                  (add-hook 'before-save-hook 'time-stamp nil 'local)))
       (leaf org-capture
       :leaf-defer t
       :if (file-directory-p my:d:gtd)
       :commands (org-capture)
       :config
       (setq org-capture-templates `(("i" " Inbox" entry (file+headline org-gtd-file "Inbox")
                                      "** %^{Brief Description}"))))
       (leaf org-appear
         :ensure t
         :hook (org-mode-hook . org-appear-mode)
         :custom
         (org-hide-emphasis-markers . t)
         (org-appear-inside-latex   . t)
         (org-appear-autosubmarkers . t)
         )
       (leaf org-mac-iCal
         :when (string= "osx" (getenv "PLATFORM"))
         :el-get
         (mkt3/org-mac-iCal :type github)
         :config
         (setq org-agenda-include-diary t)
         (setq diary-file (expand-file-name "calendar" my:d:gtd))
         (add-hook 'org-agenda-cleanup-fancy-diary-hook
                 (lambda ()
                   (goto-char (point-min))
                   (save-excursion
                     (while (re-search-forward "^[a-z]" nil t)
                       (goto-char (match-beginning 0))
                       (insert "0:00-24:00 ")))
                   (while (re-search-forward "^ [a-z]" nil t)
                     (goto-char (match-beginning 0))
                     (save-excursion
                       (re-search-backward "^[0-9]+:[0-9]+-[0-9]+:[0-9]+ " nil t))
                     (insert (match-string 0)))))
         (org-mac-iCal)
         )
       )
   #+end_src
** org-pomodoro
   #+begin_src emacs-lisp
     (leaf org-pomodoro
       :ensure t
       :after org
       :if (file-directory-p my:d:gtd)
       :custom
       (org-pomodoro-length . 50)
       (org-promodoro-short-break-length . 10)
       )
   #+end_src
** org-roam
   #+begin_src emacs-lisp
     (leaf org-roam
       :ensure t
       :after org
       :if (file-directory-p my:d:org-roam)
       :bind
       (("C-c n a" . org-roam-alias-add)
        ("C-c n f" . org-roam-node-find)
        ("C-c n i" . org-roam-node-insert)
        ("C-c n o" . org-id-get-create)
        ("C-c n t" . org-roam-tag-add)
        ("C-c n r" . org-roam-ref-add)
        ("C-c n l" . org-roam-buffer-toggle)
        ("C-c n c" . org-roam-capture)
        ("C-c n j" . org-roam-dailies-capture-today)
        )
       :init
       (setq org-roam-directory my:d:org-roam)
       (setq org-roam-dailies-directory "daily_notes/")
       (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.5))
       :defer-config
       (org-roam-db-autosync-enable)
       :custom
       ;; (org-roam-node-display-template . (concat "${type:15} ${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
       (org-roam-capture-templates
        . '(("s" "seed" plain "%?"
             :if-new (file+head "seed/${slug}.org"
                                "#+title: ${title}\n#+created: %U\n#+last_modified: %U\n")
             :immediate-finish t
             :unnarrowed t)
            ("r" "reference" plain "%?"
             :if-new
             (file+head "reference/${slug}.org" "#+title: ${title}\n#+created: %U\n#+last_modified: %U\n")
             :immediate-finish t
             :unnarrowed t)
            ("e" "evergreen" plain "%?"
             :if-new
             (file+head "evergreen/${slug}.org" "#+title: ${title}\n#+created: %U\n#+last_modified: %U\n#+filetags: :envergreen:\n")
             :immediate-finish t
             :unnarrowed t)))
       (org-roam-dailies-capture-templates
        . '(
            ("j" "journal" entry
             "** %<%H:%M> %^{title}\n%?"
             :target (file+head+olp "%<%Y-%m>.org"
                                    "#+title: %<%Y-%m>\n"
                                    ("%<%Y-%m-%d>"))
             :immediate-finish t)
            ))
       :config
       (cl-defmethod org-roam-node-type ((node org-roam-node))
         "Return the TYPE of NODE."
         (condition-case nil
             (file-name-nondirectory
              (directory-file-name
               (file-name-directory
                (file-relative-name (org-roam-node-file node) org-roam-directory))))
           (error "")))
       (setq org-roam-node-display-template
             (concat "${type:15} ${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
       (defun my:tag-new-node-as-draft ()
         (org-roam-tag-add '("draft")))
       (add-hook 'org-roam-capture-new-node-hook #'my:tag-new-node-as-draft)
       )
     (leaf org-roam-ui
       :ensure t
       :if (file-directory-p my:d:org-roam)
       :config
       (setq org-roam-ui-sync-theme t
             org-roam-ui-follow t
             org-roam-ui-update-on-save t
             org-roam-ui-open-on-start t))
     (leaf consult-org-roam
       :ensure t
       :init
       (consult-org-roam-mode 1)
       :custom
       (consult-org-roam-grep-func . #'consult-ripgrep)
       :bind
       ("C-c n e" . consult-org-roam-file-find)
       ("C-c n b" . consult-org-roam-backlinks)
       ("C-c n s" . consult-org-roam-search))
     (leaf citar
       :ensure t
       :if (file-exists-p my:f:bib)
       :require t
       :custom
       (citar-bibliography . my:f:bib)
       :config
       (defun my:org-roam-node-from-cite (keys-entries)
         (interactive (list (citar-select-ref :multiple nil :rebuild-cache t)))
         (let ((title (citar--format-entry-no-widths (cdr keys-entries)
                                                     "${author editor} :: ${title}")))
           (org-roam-capture- :templates
                              '(("r" "reference" plain "%?" :if-new
                                 (file+head "reference/${citekey}.org"
                                            ":PROPERTIES:
     :ROAM_REFS: [cite:@${citekey}]
     :END:
     ,#+title: ${title}\n")
                                 :immediate-finish t
                                 :unnarrowed t))
                              :info (list :citekey (car keys-entries))
                              :node (org-roam-node-create :title title)
                              :props '(:finalize find-file))))
       )
   #+end_src
** web-mode
   #+begin_src emacs-lisp
     (leaf web-mode
       :ensure t
       :after flycheck
       :defun flycheck-add-mode
       :mode ("\\.tsx\\'" "\\.css\\'" "\\.json\\'" "\\.p?html?\\'" "\\.php\\'")
       :config (flycheck-add-mode 'javascript-eslint 'web-mode)
       :custom ((web-mode-markup-indent-offset . 2)
                (web-mode-css-indent-offset . 2)
                (web-mode-code-indent-offset . 2)
                (web-mode-comment-style . 2)
                (web-mode-style-padding . 1)
                (web-mode-script-padding . 1)
                (web-mode-enable-auto-closing . t)
                (web-mode-enable-auto-pairing . t)
                (web-mode-auto-close-style . 2)
                (web-mode-tag-auto-close-style . 2)
                (indent-tabs-mode . nil)
                (tab-width . 2))
       :hook (web-mode-hook . (lambda ()jlj
                                (interactive)
                                (when (string-equal "tsx" (file-name-extension buffer-file-name))
                                  (add-node-modules-path)
                                  (tide-setup)
                                  (flycheck-mode +1)
                                  (setq flycheck-checker 'javascript-eslint)
                                  (eldoc-mode +1)
                                  (tide-hl-identifier-mode +1)
                                  (company-mode +1)))))
   #+end_src
** markdown-mode
   #+begin_src emacs-lisp
     (leaf markdown-mode
       :ensure t
       :mode (("\\.md\\'" "\\.markdown\\'")
              (("README\\.md\\'" . gfm-mode)))
       :custom ((markdown-fontify-code-blocks-natively . t))
       :hook ((markdown-mode-hook . (lambda ()
                                      (setq tab-width 2)
                                      ;; (setq flycheck-checker 'textlint)
                                      ;; (flycheck-mode 1)
                                                    ))))
   #+end_src
** docker-mode
   #+begin_src emacs-lisp
     (leaf *docker-mode
       :config
       (leaf docker
         :ensure t)
       (leaf dockerfile-mode
         :ensure t)
       (leaf docker-compose-mode
         :ensure t)
       (leaf docker-tramp
         :ensure t))
   #+end_src
* misc-tools
** git
   #+begin_src emacs-lisp
     (leaf *git-tools
       :config
       (leaf git-modes
         :ensure t)
       (leaf magit
         :ensure t
         :preface (defun c/git-add ()
                    "Add anything."
                    (interactive)
                    (shell-command "git add ."))
         (defun c/git-commit-a ()
           "Commit after add anything."
           (interactive)
           (c/git-add)
           (magit-commit-create))
         :bind (("C-x g" . magit-status)
                ("C-x M-g" . magit-dispatch-popup))))
   #+end_src
** shell-pop
   #+begin_src emacs-lisp
     (leaf shell-pop
       :ensure t
       :bind* (("C-t" . shell-pop))
       :config (custom-set-variables '(shell-pop-shell-type (quote ("ansi-term" "*ansi-term*" (lambda
                                                                                                nil
                                                                                                (ansi-term
                                                                                                 shell-pop-term-shell)))))
                                     '(shell-pop-window-size 30)
                                     '(shell-pop-full-span t)
                                     '(shell-pop-window-position "bottom"))
       ;; 終了時のプロセス確認を無効化
       (defun set-no-process-query-on-exit ()
         (let ((proc (get-buffer-process (current-buffer))))
           (when (processp proc)
             (set-process-query-on-exit-flag proc nil))))
       (add-hook 'term-exec-hook 'set-no-process-query-on-exit))
   #+end_src
